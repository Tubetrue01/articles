<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/articles/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/articles/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/articles/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/articles/images/logo.svg" color="#222">

<link rel="stylesheet" href="/articles/css/main.css">


<link rel="stylesheet" href="/articles/libs/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tubetrue01.github.io","root":"/articles/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Tubetrue01">
<meta property="og:url" content="https://tubetrue01.github.io/page/33/">
<meta property="og:site_name" content="Tubetrue01">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tubetrue01">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://tubetrue01.github.io/page/33/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Tubetrue01</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/articles/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tubetrue01</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/articles/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/articles/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/articles/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://www.jianshu.com/u/46af180aa88f" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tubetrue01.github.io/2021/09/04/c_unix/TCP(%E4%B8%80)Three-Way-Handshake/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/articles/img/head.PNG">
      <meta itemprop="name" content="Tubetrue01">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tubetrue01">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/2021/09/04/c_unix/TCP(%E4%B8%80)Three-Way-Handshake/" class="post-title-link" itemprop="url">TCPï¼ˆä¸€ï¼‰ä¸‰æ¬¡æ¡æ‰‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-09-04 23:52:58" itemprop="dateCreated datePublished" datetime="2021-09-04T23:52:58+08:00">2021-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-09-07 09:37:49" itemprop="dateModified" datetime="2021-09-07T09:37:49+08:00">2021-09-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><blockquote>
<p>ä¸ºäº†è®©å¤§å®¶å¯¹ä¸‰æ¬¡æ¡æ‰‹æœ‰ä¸ªæ›´æ·±å…¥çš„ç†è§£ï¼Œè¿™é‡Œé€‰å–äº†ä¸€ä¸ªç»å…¸çš„æ¡ˆä¾‹ã€‚</p>
</blockquote>
<h1 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h1><p>Java çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä½¿ç”¨ socket è¿›è¡Œé€šè®¯ã€‚æœ¬ä¾‹ä¸­ï¼Œä½¿ç”¨ NIO å‘ç”Ÿäº†ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´é—´æ­‡çš„è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ä»¥åˆ›å»ºè¿æ¥ï¼Œè€Œç›‘å¬å¥—æ¥å­—å´æ²¡æœ‰ä»»ä½•å“åº”ã€‚</li>
<li>é—®é¢˜åŒæ—¶å‡ºç°åœ¨è®¸å¤šå…¶ä»–è¿æ¥ä¸­ã€‚</li>
<li>NIO çš„ select å¹¶æ²¡æœ‰æ‘§æ¯é‡å»ºï¼Œç”¨åˆ°çš„æ€»æ˜¯ç¬¬ä¸€ä¸ªã€‚</li>
<li>é—®é¢˜åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™å‡ºç°ï¼Œå¹¶åœ¨æ­¤åæ–­æ–­ç»­ç»­ã€‚</li>
</ul>
<h2 id="ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸‰æ¬¡æ¡æ‰‹</h2><p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯å‘é€ SYN åŒ…ç»™æœåŠ¡å™¨ä»¥æ­¤åˆå§‹åŒ–æ¡æ‰‹ã€‚</li>
<li>æ”¶åˆ° SYN ä¹‹åï¼ŒæœåŠ¡ç«¯å“åº” SYN-ACK åŒ…ã€‚</li>
<li>æœ€åï¼Œå®¢æˆ·ç«¯å‘é€ ACK åŒ…ç»™æœåŠ¡å™¨ï¼Œå‘ŠçŸ¥å®ƒæ”¶åˆ°äº†æœåŠ¡å™¨å‘æ¥çš„ SYN-ACK åŒ…ï¼ˆæ­¤æ—¶ï¼ŒæœåŠ¡ç«¯å·²ç»é€šè¿‡ç«¯å£ 61270 ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼‰ã€‚</li>
</ol>
<hr>
<img src="/articles/2021/09/04/c_unix/TCP(%E4%B8%80)Three-Way-Handshake/01.jpg" class="" width="923">

<hr>
<h2 id="å¿«é€Ÿè§£å†³é—®é¢˜"><a href="#å¿«é€Ÿè§£å†³é—®é¢˜" class="headerlink" title="å¿«é€Ÿè§£å†³é—®é¢˜"></a>å¿«é€Ÿè§£å†³é—®é¢˜</h2><p>æ ¹æ®é—®é¢˜ç°è±¡åˆ†æï¼Œå¾ˆåƒæ˜¯å½“å»ºç«‹ TCP è¿æ¥æ—¶ TCP å·²å®Œæˆè¿æ¥é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼ˆæˆ‘ä»¬ç¨åè®¨è®ºå®ƒï¼‰ã€‚ä¸ºäº†ç¡®è®¤ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹é˜Ÿåˆ—çš„æº¢å‡ºä¿¡æ¯ <code>netstat -s | egrep &#39;listen&#39;</code> ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">667399 times the listen queue of a socket overflowed</span><br></pre></td></tr></table></figure>
<p>å°è¯•äº†ä¸‰æ¬¡ä¹‹åï¼Œå‘ç°è¯¥å€¼åœ¨æŒç»­å¢åŠ ã€‚åˆ°è¿™é‡Œå…¶å®å·²ç»å¾ˆæ˜ç¡®äº†ï¼ŒæœåŠ¡å™¨çš„å·²å®Œæˆè¿æ¥é˜Ÿåˆ—ï¼ˆaccept é˜Ÿåˆ—ï¼‰å·²ç»æº¢å‡ºäº†ã€‚æˆ‘ä»¬çœ‹ä¸‹ç³»ç»Ÿæ˜¯æ€ä¹ˆå¤„ç†æº¢å‡ºé—®é¢˜çš„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#  cat /proc/sys/net/ipv4/tcp_abort_on_overflow</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<p>å½“ <code>tcp_abort_on_overflow </code> ä¸º 0 æ—¶ï¼Œå¦‚æœ accept é˜Ÿåˆ—åœ¨ä¸‰æ¬¡æ¡æ‰‹æ—¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯å°±ä¼šä¸¢æ‰å®¢æˆ·ç«¯å‘æ¥çš„ ACK åŒ…ã€‚ä¹Ÿå°±è¯´åœ¨æœåŠ¡ç«¯å¹¶æ²¡æœ‰å»ºç«‹å¥½è¿æ¥ã€‚</p>
<p>ä¸ºäº†è¯å®è¯¥é—®é¢˜ä¸å®Œæˆè¿æ¥é˜Ÿåˆ—çš„ç›¸å…³æ€§ï¼Œæˆ‘ä»¬æŠŠ <code>tcp_abort_on_overflow</code> è®¾ç½®ä¸º 1ã€‚å¦‚æœåœ¨æ¡æ‰‹çš„ç¬¬ä¸‰æ­¥æ—¶å®Œæˆè¿æ¥é˜Ÿåˆ—å·²æ»¡ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯å°±ä¼šå‘é€ä¸€ä¸ª reset åŒ…ç»™å®¢æˆ·ç«¯ï¼Œç”¨ä»¥å‘ŠçŸ¥ç»“æŸä¸¤è¾¹çš„æ¡æ‰‹ä»¥åŠè¿æ¥ï¼ˆäº‹å®ä¸Šï¼Œåœ¨æœåŠ¡ç«¯è¿æ¥è¿˜å¹¶æ²¡æœ‰å®Œæˆï¼‰ã€‚</p>
<p>ç»§ç»­æµ‹è¯•ï¼Œå‘ç°åœ¨å®¢æˆ·ç«¯ä¼šå‡ºç°å¾ˆå¤š <code>connection reset by peer</code> å¼‚å¸¸ã€‚è¿™ä¹Ÿå°±èƒ½å¾—å‡ºç»“è®ºï¼Œå®Œæˆé˜Ÿåˆ—æº¢å‡ºå¯¼è‡´å®¢æˆ·ç«¯å‡ºç°é”™è¯¯ä¿¡æ¯ï¼Œè¿™ä¹Ÿå¸®æˆ‘ä»¬å¿«é€Ÿå®šä½äº†é—®é¢˜çš„å…³é”®éƒ¨åˆ†ã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹ java æºç å‘ç°ï¼Œlisten å‡½æ•° backlog å‚æ•°çš„é»˜è®¤å€¼ä¸º 50ï¼ˆè¯¥å€¼æ§åˆ¶ç€å®Œæˆé˜Ÿåˆ—çš„å¤§å°ï¼‰ã€‚æé«˜è¯¥å€¼çš„å¤§å°ï¼Œå†æ¬¡è¿è¡Œç¨‹åºï¼Œè¿›è¡Œ 12 å°æ—¶çš„å‹åŠ›æµ‹è¯•ï¼Œæˆ‘ä»¬å‘ç°ï¼Œé”™è¯¯ä¸å†å‘ç”Ÿï¼Œæº¢å‡ºé—®é¢˜ä¹Ÿä¸å†é€’å¢ã€‚</p>
<p>è¿™ä¸ªä¾‹å­å¾ˆç®€å•ï¼Œè¯¥é—®é¢˜åªæ˜¯å› ä¸ºä¸‰æ¬¡æ¡æ‰‹æ—¶å®Œæˆé˜Ÿåˆ—è¢«å¡«æ»¡å¯¼è‡´çš„ï¼Œè€Œåªæœ‰è¿›å…¥åˆ°é˜Ÿåˆ—çš„ï¼ŒæœåŠ¡æ‰èƒ½ä» listen è½¬å˜ä¸º acceptã€‚å¯¹äºé»˜è®¤å€¼åªæœ‰ 50 çš„ backlog æ¥è¯´ï¼Œæº¢å‡ºå®¹æ˜“å‘ç”Ÿã€‚ä¸€æ—¦å‘ç”Ÿæº¢å‡ºï¼Œä¸‰æ¬¡æ¡æ‰‹ç¬¬ä¸‰æ­¥ï¼ŒæœåŠ¡ç«¯å°±ä¼šå¿½ç•¥å®¢æˆ·ç«¯å‘è¿‡æ¥çš„ ACK åŒ…ã€‚æœåŠ¡ç«¯å°†ä¼šå®šæœŸé‡å¤ç¬¬äºŒæ­¥ï¼ˆå‘é€ SYN-ACK åŒ…ç»™å®¢æˆ·ç«¯ï¼‰ã€‚å¦‚æœè¿æ¥æ²¡æœ‰è¿›å…¥é˜Ÿåˆ—ï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸€ä¸ªå¼‚å¸¸ã€‚</p>
<p>å°½ç®¡é—®é¢˜è§£å†³äº†ï¼Œä½†æ˜¯è¿™å¹¶æ²¡æœ‰è®©äººæ»¡æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ›´æ·±å…¥çš„äº†è§£ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ã€‚</p>
<h1 id="æ·±å…¥è¯é¢˜ï¼šTCP-æ¡æ‰‹æœºåˆ¶ä¸é˜Ÿåˆ—"><a href="#æ·±å…¥è¯é¢˜ï¼šTCP-æ¡æ‰‹æœºåˆ¶ä¸é˜Ÿåˆ—" class="headerlink" title="æ·±å…¥è¯é¢˜ï¼šTCP æ¡æ‰‹æœºåˆ¶ä¸é˜Ÿåˆ—"></a>æ·±å…¥è¯é¢˜ï¼šTCP æ¡æ‰‹æœºåˆ¶ä¸é˜Ÿåˆ—</h1><hr>
<img src="/articles/2021/09/04/c_unix/TCP(%E4%B8%80)Three-Way-Handshake/02.jpg" class="" width="873">

<hr>
<p>å¦‚ä¸Šå›¾ï¼Œæœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</p>
<ul>
<li>SYN é˜Ÿåˆ—ï¼ˆæœªè¿æ¥é˜Ÿåˆ—ï¼‰</li>
<li>Accept é˜Ÿåˆ—ï¼ˆå·²å®Œæˆè¿æ¥é˜Ÿåˆ—ï¼‰</li>
</ul>
<p>ä¸‰æ¬¡æ¡æ‰‹ä¸­ï¼Œåœ¨æœåŠ¡ç«¯æ”¶åˆ° SYN åŒ…ä¹‹åï¼ŒæœåŠ¡ç«¯å°†è¿æ¥ä¿¡æ¯æ”¾åˆ° SYN é˜Ÿåˆ—é‡Œï¼Œæ¥ç€å‘é€ SYN-ACK åŒ…ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘é€æ¥çš„ ACK åŒ…ã€‚å¦‚æœ Accept é˜Ÿåˆ—æœªæ»¡ï¼Œé‚£ä¹ˆå°†ä¼šä» SYN é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œå¹¶å°†å®ƒæ”¾åˆ° Accept é˜Ÿåˆ—ä¸­ã€‚æˆ–è€…æŒ‰ç…§ <code>tcp_abort_on_overflow</code> æŒ‡ç¤ºæ‰§è¡Œã€‚</p>
<p>æ­¤æ—¶ï¼Œå¦‚æœ Accept é˜Ÿåˆ—å·²æ»¡è€Œ <code>tcp_abort_on_overflow</code> ä¸º 0ï¼Œä¸€æ®µæ—¶é—´åï¼ŒæœåŠ¡ç«¯å°±ä¼šå†æ¬¡å‘é€ä¸€ä¸ª SYN-ACK åŒ…ç»™å®¢æˆ·ç«¯ï¼ˆä¹Ÿå°±æ˜¯ï¼Œå®ƒä¼šé‡å¤æ¡æ‰‹çš„ç¬¬äºŒæ­¥ï¼‰ã€‚å³ä½¿å®¢æˆ·ç«¯è¶…æ—¶å¾ˆçŸ­ï¼Œè¿™ä¹Ÿå¾ˆå®¹æ˜“å¯¼è‡´å®¢æˆ·ç«¯å¼‚å¸¸ã€‚</p>
<p>CentOS ä¸‹ï¼Œç¬¬äºŒæ­¥ä¼šé‡è¯• 5 æ¬¡ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# cat /proc/sys/net/ipv4/tcp_synack_retries</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<h2 id="ä¸€ç§æ–°æ–¹æ³•"><a href="#ä¸€ç§æ–°æ–¹æ³•" class="headerlink" title="ä¸€ç§æ–°æ–¹æ³•"></a>ä¸€ç§æ–°æ–¹æ³•</h2><p>ä»¥ä¸Šçš„è§£å†³åŠæ³•å¯èƒ½ä¼šè®©äººæ„Ÿåˆ°å›°æƒ‘ï¼Œæœ‰æ²¡æœ‰ç®€å•å¿«é€Ÿçš„æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹å‡ ä¸ªæœ‰ç”¨çš„å‘½ä»¤ï¼š</p>
<ul>
<li><h3 id="netstat-â€“s"><a href="#netstat-â€“s" class="headerlink" title="netstat â€“s"></a>netstat â€“s</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# netstat -s | egrep &quot;listen|LISTEN&quot; </span><br><span class="line">667399 times the listen queue of a socket overflowed</span><br><span class="line">667399 SYNs to LISTEN sockets ignored</span><br></pre></td></tr></table></figure>
<p>è¯¥ä¾‹å­ä¸­ï¼Œæœ‰ 667399 æ¬¡ Accept é˜Ÿåˆ—æº¢å‡ºã€‚æ¯å‡ ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡è¯¥å‘½ä»¤ï¼Œè§‚å¯Ÿè¯¥æ¬¡æ•°æ˜¯å¦é€’å¢ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆè¯´æ˜ Accept é˜Ÿåˆ—è‚¯å®šæ»¡äº†ã€‚</p>
</li>
<li><h3 id="ss"><a href="#ss" class="headerlink" title="ss"></a>ss</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ss -lnt</span><br><span class="line">Recv-Q   Send-Q   Local Address:Port    Peer Address:Port </span><br><span class="line">0          50               *:3306             *:*</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼ŒSend-Q ä¸º 50 è¯´æ˜ 3306 ç›‘å¬ç«¯å£çš„ Accept é˜Ÿåˆ—èƒ½æ¥å—çš„è¿æ¥æœ€å¤š 50ã€‚Recv-Q è¡¨ç¤ºå½“å‰ Accept é˜Ÿåˆ—ä½¿ç”¨äº†å¤šå°‘ã€‚</p>
<p>Accept é˜Ÿåˆ—çš„å¤§å°ä¾èµ–äº <code>min(backlog, somaxconn)</code>ã€‚backlog å‚æ•°æ˜¯åˆ›å»º socket æ—¶ï¼Œlisten å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚somaxconn åˆ™æ˜¯ä¸€ä¸ªç³»ç»Ÿçº§çš„å‚æ•°ã€‚</p>
<p>SYN é˜Ÿåˆ—çš„å¤§å°ä¾èµ–äº <code>max(64, /proc/sys/net/ipv4/tcp_max_syn_backlog)</code>ï¼Œä¸åŒçš„ç³»ç»Ÿç‰ˆæœ¬å¯èƒ½ä¼šæœ‰ä¸åŒã€‚</p>
<p><strong>ğŸ“š Tips</strong></p>
<blockquote>
<p>backlog åœ¨ Linux 2.2 ä¹‹åè¡¨ç¤ºçš„æ˜¯å·²å®Œæˆä¸‰æ¬¡æ¡æ‰‹ä½†è¿˜æœªè¢«åº”ç”¨ç¨‹åº Accept é˜Ÿåˆ—çš„é•¿åº¦ã€‚åœ¨è¿™ä¹‹å‰åˆ™è¡¨ç¤ºæœªå®Œæˆçš„è¿æ¥å¯èƒ½å¢é•¿åˆ°çš„æœ€å¤§é˜Ÿåˆ—é•¿åº¦ã€‚</p>
</blockquote>
</li>
</ul>
<ul>
<li><h3 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h3><p>Send-Q ä»¥åŠ Recv-Q ä¿¡æ¯ä¹Ÿå¯ä»¥é€šè¿‡ netstat å‘½ä»¤æ˜¾ç¤ºã€‚å¦‚æœè¿æ¥å¹¶éå¤„äºç›‘å¬çŠ¶æ€ï¼ŒRecv-Q è¡¨ç¤ºæ”¶åˆ°çš„æ•°æ®ä»ç„¶åœ¨ç¼“å­˜é‡Œå¹¶æ²¡æœ‰è¢«ç¨‹åºè¯»å–ã€‚Recv-Q å¯¹åº”çš„æ•°å€¼è¡¨ç¤ºæœªè¯»å–çš„å­—èŠ‚æ•°ã€‚Send-Q å¯¹åº”çš„æ•°å€¼è¡¨ç¤ºå‘é€é˜Ÿåˆ—ä¸­æœªè¢«è¿œç¨‹ä¸»æœºç¡®è®¤çš„å­—èŠ‚æ•°ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# netstat -tn  </span><br><span class="line">Active Internet connections (w/o servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address   Foreign Address State  </span><br><span class="line">tcp0  0 100.81.180.187:8182  10.183.199.10:15260 SYN_RECV   </span><br><span class="line">tcp0  0 100.81.180.187:43511 10.137.67.18:19796  TIME_WAIT   </span><br><span class="line">tcp0  0 100.81.180.187:2376  100.81.183.84:42459 ESTABLISHED</span><br></pre></td></tr></table></figure>
<p>æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œé€šè¿‡ <code>netstat -tn</code> å‘½ä»¤å±•ç¤ºçš„ Recv-Q æ•°æ®ä¸ Accept é˜Ÿåˆ—æˆ–è€… SYN é˜Ÿåˆ—æ— å…³ã€‚è¿™é‡Œéœ€è¦ç‰¹åˆ«å¼ºè°ƒï¼Œä»¥å…ä¸ <code>ss -lnt</code> å±•ç¤ºçš„ Recv-Q æ•°æ®ç›¸æ··æ·†ã€‚</p>
<p>ä¸‹å›¾ <code>netstat -t</code> å±•ç¤ºçš„ Recv-Q å·²ç»ç§¯ç´¯äº†å¤§éƒ¨åˆ†æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¸€èˆ¬æ˜¯ç”± CPU å¤„ç†å¤±è´¥å¯¼è‡´çš„ã€‚</p>
</li>
</ul>
<hr>
  <img src="/articles/2021/09/04/c_unix/TCP(%E4%B8%80)Three-Way-Handshake/03.jpg" class="" width="866">

<hr>
<p>  <strong>ğŸ“š Tips</strong></p>
<blockquote>
<p>LISTEN çŠ¶æ€: Recv-Q è¡¨ç¤ºçš„å½“å‰ç­‰å¾…æœåŠ¡ç«¯è°ƒç”¨ accept å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„ listen backlog æ•°å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡ connect() å»è¿æ¥æ­£åœ¨ listen() çš„æœåŠ¡ç«¯æ—¶ï¼Œè¿™äº›è¿æ¥ä¼šä¸€ç›´å¤„äºè¿™ä¸ª queue é‡Œé¢ç›´åˆ°è¢«æœåŠ¡ç«¯ accept()ï¼›Send-Q è¡¨ç¤ºçš„åˆ™æ˜¯æœ€å¤§çš„ listen backlog æ•°å€¼ï¼Œè¿™å°±å°±æ˜¯ä¸Šé¢æåˆ°çš„ min(backlog, somaxconn) çš„å€¼ã€‚<br>  å…¶ä½™çŠ¶æ€: Recv-Q è¡¨ç¤º receive queue ä¸­çš„ bytes æ•°é‡ï¼›Send-Q è¡¨ç¤º send queue ä¸­çš„ bytes æ•°å€¼ã€‚</p>
</blockquote>
<ul>
<li><h3 id="éªŒè¯è¿‡ç¨‹"><a href="#éªŒè¯è¿‡ç¨‹" class="headerlink" title="éªŒè¯è¿‡ç¨‹"></a>éªŒè¯è¿‡ç¨‹</h3><p>ä¸ºäº†éªŒè¯ä»¥ä¸Šæè¿°çš„ä¿¡æ¯ï¼Œå°† backlog å¤§å°è®¾ç½®ä¸º 10ï¼ˆå½“ç„¶ï¼Œå€¼è¶Šå°ï¼Œè¶Šå®¹æ˜“æº¢å‡ºï¼‰ï¼Œç»§ç»­è¿è¡Œæµ‹è¯•ç¨‹åºã€‚å½“å®¢æˆ·ç«¯å‡ºç°å¼‚å¸¸ä¿¡æ¯åï¼Œåœ¨æœåŠ¡ç«¯é€šè¿‡ ss å‘½ä»¤è§‚å¯Ÿåˆ°çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Fri May  5 13:50:23 CST 2017</span><br><span class="line">Recv-Q   Send-Q    Local Address:Port    Peer Address:Port</span><br><span class="line">11         10         *:3306               *:*</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°ç›‘å¬åœ¨ 3306 ä¸Šçš„æœåŠ¡ Accept é˜Ÿåˆ—æœ€å¤§ä¸º 10ï¼Œä½†æ˜¯åœ¨é˜Ÿåˆ—ä¸­å·²ç»æœ‰ 11 ä¸ªè¿æ¥ã€‚é‚£ä¹ˆè‚¯å®šä¼šæœ‰ä¸€ä¸ªæ— æ³•å…¥é˜Ÿï¼Œå¹¶ä¸”å‘ç”Ÿæº¢å‡ºã€‚åŒæ—¶ï¼Œæº¢å‡ºçš„æ•°é‡å€¼ä¹Ÿåœ¨é€æ¸å¢åŠ ã€‚</p>
</li>
</ul>
<h1 id="Tomcat-and-Nginx-ä¸­çš„-Accept-é˜Ÿåˆ—å¤§å°"><a href="#Tomcat-and-Nginx-ä¸­çš„-Accept-é˜Ÿåˆ—å¤§å°" class="headerlink" title="Tomcat and Nginx ä¸­çš„ Accept é˜Ÿåˆ—å¤§å°"></a>Tomcat and Nginx ä¸­çš„ Accept é˜Ÿåˆ—å¤§å°</h1><p>Tomcat é»˜è®¤æ˜¯ç¬æ€è¿æ¥ï¼Œé»˜è®¤å€¼ä¸º 100ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ss -lnt</span><br><span class="line">Recv-Q Send-Q   Local Address:Port Peer Address:Port</span><br><span class="line">0       100                 *:8080            *:*</span><br></pre></td></tr></table></figure>
<p>Nginx é»˜è®¤å€¼ä¸º 511ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# sudo ss -lnt</span><br><span class="line">State  Recv-Q Send-Q Local Address:PortPeer Address:Port</span><br><span class="line">LISTEN    0     511              *:8085           *:*</span><br><span class="line">LISTEN    0     511              *:8085           *:*</span><br></pre></td></tr></table></figure>

<p>Nginx è¿è¡Œåœ¨å¤šè¿›ç¨‹æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰å¤šä¸ªè¿›ç¨‹ç›‘å¬åœ¨ 8085 ç«¯å£ä¸‹ã€‚è¿™ä¹Ÿæ„å‘³ç€é¿å…äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œç›¸åº”åœ°æå‡äº†æ€§èƒ½ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸€æ—¦å‘ç”Ÿæº¢å‡ºï¼Œè™½ç„¶ CPU è·Ÿçº¿ç¨‹çŠ¶æ€çœ‹èµ·æ¥å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯å‹åŠ›æŒ‡æ•°å¾ˆä½ã€‚ä»å®¢æˆ·ç«¯å±‚é¢åˆ†æï¼Œå“åº”æ—¶é—´å¾ˆé•¿ï¼Œä½†æ˜¯æœåŠ¡æ—¥å¿—ä¸­ï¼ŒçœŸå®çš„æœåŠ¡æ—¶é—´å¾ˆçŸ­ã€‚ä¸€äº›ç½‘ç»œå±‚æ¡†æ¶å¦‚ï¼šJDKã€Netty ç”±äº backlog çš„å€¼å¾ˆå°ï¼Œè¿™ä¹Ÿå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚</p>
<hr>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a target="_blank" rel="noopener" href="https://hackernoon.com/tcp-three-way-handshake-4161eb8aba32">ã€TCP Three-Way Handshakeã€‘</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/articles/page/32/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/articles/">1</a><span class="space">&hellip;</span><a class="page-number" href="/articles/page/32/">32</a><span class="page-number current">33</span><a class="page-number" href="/articles/page/34/">34</a><span class="space">&hellip;</span><a class="page-number" href="/articles/page/67/">67</a><a class="extend next" rel="next" href="/articles/page/34/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tubetrue01"
      src="/articles/img/head.PNG">
  <p class="site-author-name" itemprop="name">Tubetrue01</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/articles/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/articles/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Tubetrue01" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Tubetrue01" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tubetrue01</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/articles/libs/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="/articles/libs/velocity/velocity.min.js"></script>
  <script src="/articles/libs/velocity/velocity.ui.min.js"></script>

<script src="/articles/js/utils.js"></script>

<script src="/articles/js/motion.js"></script>


<script src="/articles/js/schemes/pisces.js"></script>


<script src="/articles/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  


    </div>
</body>
</html>
