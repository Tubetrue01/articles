<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/articles/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/articles/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/articles/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/articles/images/logo.svg" color="#222">

<link rel="stylesheet" href="/articles/css/main.css">


<link rel="stylesheet" href="/articles/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tubetrue01.github.io","root":"/articles/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Tubetrue01">
<meta property="og:url" content="https://tubetrue01.github.io/page/3/">
<meta property="og:site_name" content="Tubetrue01">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tubetrue01">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://tubetrue01.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Tubetrue01</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/articles/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tubetrue01</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/articles/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/articles/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/articles/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tubetrue01.github.io/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/articles/img/head.PNG">
      <meta itemprop="name" content="Tubetrue01">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tubetrue01">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/" class="post-title-link" itemprop="url">家庭网络环境改造</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-13 15:48:05" itemprop="dateCreated datePublished" datetime="2023-09-13T15:48:05+08:00">2023-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-13 17:52:17" itemprop="dateModified" datetime="2024-03-13T17:52:17+08:00">2024-03-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><blockquote>
<p>为了实现全屋代理，我选择 R4S 作为我家庭网络中的主路由，Linksys MX5300 作为二级路由，代理方案使用 OpenClash 插件。由于整套环境存在些许问题，所以利用周末的时间，改造下上网环境。</p>
</blockquote>
<h1 id="问题根源"><a href="#问题根源" class="headerlink" title="问题根源"></a>问题根源</h1><p>当上网稳定的情况下，我一般是很少再动了。毕竟如果一旦出现问题，会导致家庭网络瘫痪从而使家中所有智能设备全部掉线，如果设备支持自动连接还好，但是不支持自动连接的问题就大了。 另外如果导致软路由断网，那基本上可以宣告 Game Over 了。</p>
<p>既然如此，为什么还要冒着断网的风险去重新配网呢？而且还是在身居外地的情况下，究其原因无非以下几点：</p>
<ul>
<li>硬路由以二级路由配置，导致网络中存在两次 NAT 转换。</li>
<li>由于存在 NAT，软路由无法拿到网络中所有的上网设备进而无法对网络中的每个设备做监管。</li>
<li>网络由 OpenClash 统一接管，模式为 Fake—IP 增强，绕过中国大陆地址。我需要完全自定义 DNS 解析，避免全权交由 OpenClash 处理以增加解析成本。</li>
<li>作为二级路由的 Linksys 每次断电都会亮红灯且无法修复，所以不得不对软路由再次重启以解决红灯问题（虽然红灯，但是网络连接丝毫无影响，原因是该路由会定期发送心跳，而该心跳被代理返回了 Fake-IP，从而导致红灯）。</li>
</ul>
<p>由于存在以上四点主要问题，所以就不得不优化一下网络了。</p>
<h2 id="网络桥接"><a href="#网络桥接" class="headerlink" title="网络桥接"></a>网络桥接</h2><p>前两种问题是最好解决的，但是也比较麻烦。之所以好解决，是因为将硬路由的上网模式改为桥接即可。但是桥接可能丧失路由的 Mesh 组网功能，这点需要注意。</p>
<p>前两种问题解决了，但是会迎来另一个棘手的问题。为了保证家庭 wifi 的安全性，我们一般都会进行 MAC 绑定，然后仅允许绑定 MAC 的设备上网。但是桥接之后，这部分功能也丧失了。</p>
<p>软路由能解决吗？当然，而且方案有很多种。可以采用防火墙限制上网设备，但是为了追求简单干脆，我用另外一种也就是 DHCP 分发的手段限制可连接 WIFI 的上网设备。如果 DHCP 不分发 IP，那么 WIFI 自然而然就连不上了。</p>
<p>我们按照下图的步骤，依次打开【网络】-&gt;【接口】-&gt;【LAN】-&gt;【修改】</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/01.jpg" class="" width="700">

<p>下划到底部，打开【高级设置】，取消【动态 DHCP】，如图：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/02.jpg" class="" width="700">

<p>取消之后，所有的设备只有进行静态登记之后才能连上 WIFI。我们通过下图：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/03.jpg" class="" width="700">

<p>【网络】-&gt;【DHCP/DNS】划到【静态地址分配】，添加 MAC 地址及 IP 即可。</p>
<h2 id="在线用户"><a href="#在线用户" class="headerlink" title="在线用户"></a>在线用户</h2><p>我们知道硬路由有一个功能就是可以实时显示在线设备，而软路由实现此功能需要另外一个插件：<a target="_blank" rel="noopener" href="https://github.com/rufengsuixing/luci-app-onliner">【onliner】</a></p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/04.jpg" class="" width="700">

<p>为了避免缺少依赖，一定要下载 all.ipk 版。</p>
<h1 id="DNS-分流"><a href="#DNS-分流" class="headerlink" title="DNS 分流"></a>DNS 分流</h1><blockquote>
<p>目前的代理方案是使用 OpenClash 的 Fake-IP 增强模式，并开启【绕过中国大陆 IP】，这也是我一直以来常用的方式。那这有什么弊端呢？</p>
</blockquote>
<h2 id="OpenClash"><a href="#OpenClash" class="headerlink" title="OpenClash"></a>OpenClash</h2><h3 id="首先要明白的是，该方案存在-DNS-污染吗？"><a href="#首先要明白的是，该方案存在-DNS-污染吗？" class="headerlink" title="首先要明白的是，该方案存在 DNS 污染吗？"></a>首先要明白的是，该方案存在 DNS 污染吗？</h3><p>回答这个问题前，我们需要了解 DNS 在 OpenClash 中的应用场景：</p>
<ul>
<li>解析域名，判断是否命中 IP 类规则</li>
<li>进行直连（DIRECT）时，解析域名与远端连接</li>
<li>作为一个 DNS 调度服务器</li>
</ul>
<p>通过以上应用分析，要想实现 DNS 污染，需要符合以下几种情况：</p>
<ul>
<li>域名类规则没有命中</li>
<li>命中 IP 类或 MATCH 规则且直连</li>
</ul>
<h4 id="例-1"><a href="#例-1" class="headerlink" title="例 1"></a>例 1</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Rule:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;GEOIP,US,Proxy&quot;</span> <span class="comment"># IP 为美国时走代理</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;MATCH,DIRECT&quot;</span>   <span class="comment"># 其余请求直连</span></span><br></pre></td></tr></table></figure>

<p>我们看下以上例子，如果 IP 命中 US，那么走代理，否则走直连。此时如果访问 google.com 由于规则中并没有基于域名的规则，那么就需要进行 DNS 解析，此时就会得到一个经过污染了的保留 IP， 而该保留 IP 并非美国 IP，所以走直连。也就是说以上配置存在 DNS 污染问题。</p>
<h4 id="例-2"><a href="#例-2" class="headerlink" title="例 2"></a>例 2</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Rule:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;GEOIP,CN,DIRECT&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;MATCH,Proxy&quot;</span></span><br></pre></td></tr></table></figure>

<p>以上配置可以避免大部分的污染问题，因为为了保证国内地址的可访问性，一般是很少将国外的域名污染成国内的 IP。但是，如果呢？我们可以在 IP 规则之前加上域名规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Rule:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;DOMAIN-SUFFIX,google.com,Proxy&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;GEOIP,CN,DIRECT&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;MATCH,Proxy&quot;</span></span><br></pre></td></tr></table></figure>

<p>这样一来就可以解决域名污染的问题了。</p>
<h3 id="DNS-解析"><a href="#DNS-解析" class="headerlink" title="DNS 解析"></a>DNS 解析</h3><p>OpenClash 提供了 nameserver 及 fallback 来配置 DNS。我们看下具体的流程：</p>
<p>1、从 nameserver 和 fallback 里的 DNS 进行并发请求，并且选取 nameserver 中最先响应的结果作为基准； 2、使用 GEOIP 判断此 IP 的所属区域，如果属于国内（CN）或保留地址则直接响应给客户端； 3、其他情况则把 fallback 中的结果响应给客户端；</p>
<p>我们以例 2 中的规则为例子并以 Fake-IP 模式进行说明：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Rule:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;GEOIP,CN,DIRECT&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;MATCH,Proxy&quot;</span></span><br></pre></td></tr></table></figure>

<p>当客户端发送对 google.com 的请求时，会被 OpenClash 劫持然后返回一个 Fake-IP 并做好与域名的绑定。客户端拿到 Fake-IP 并对其进行请求，该请求再次被 OpenClash 拦截， 并根据绑定关系拿到该 Fake-IP 对应的 google.com。然后根据规则查找，发现没有基于域名的规则，而仅有的 IP 规则并没有 no-resolve 选项。那么就需要对 google.com 进行 DNS 解析。 OpenClash 会对 nameserver 及 fallback 中的 DNS 进行并发请求。由于是对外请求的，那么该 DNS 查询就会被 DNS 服务器主动污染或者运营商劫持。出现这个问题我们一般是更换 DNS 以及 将 fallback 指向 国外 DNS。但是对于运营商提供的 DNS 我们就无能为力了。此时 OpenClash 就会拿到 nameserver、fallback 双方解析出来的 IP。如果该 IP 是国内的，那么就采用该 IP 进行规则判断，如果 该 IP 是国外的，那么就采用 fallback 的结果进行规则判断。如果是直连模式，那么就直接用解析出来的 IP 发送请求；如果是代理模式，就将请求域名发送给代理服务器，由代理 服务器完成 DNS 解析。</p>
<p>通过以上分析，其实我们发现，以上配置其实能够解决绝大部分的污染问题，对于一般的用户也基本够用了。但是如果仔细推敲其实这里是有问题的，Fake-IP 模式下的 OpenClash 对于 DNS 的解析仅仅 用于代理规则判断，如果是直连模式时才会进行实际的请求。那么解析时，由于是 nameserver、fallback 并发请求，如果 nameserver 配置为国内 DNS 时，对于国外域名的请求，国内 DNS 就会有 解析记录，此时就会涉及到隐私安全问题。那么你可能就会想，直接把 nameserver 配置为国外 DNS 不就行了，那么国内域名的解析就有问题了。</p>
<p>另外，对于 Fake-IP，有些客户端就会表现出异样的行为，比如我那台领势路由器就会亮红灯。另一方面，我们希望国内的域名返回真实的 IP，只有需要代理的域名返回 Fake-IP（不要说通过 Fake-IP-Filter 实现）。</p>
<p>对于以上问题，总结一下我们的需求： 1、对于国内的域名走国内 DNS 解析并返回真实 IP。 2、对于国外的域名走国外解析，跳过国内解析过程，避免留下印记。 3、对于国内的请求直接跳过 OpenClash 的处理，一方面加快响应，另一方面避免由于 OpenClash 崩溃导致所有设备断网。</p>
<p>如果你也有以上需求，那么我们可以继续往下看了！</p>
<h2 id="MosDNS"><a href="#MosDNS" class="headerlink" title="MosDNS"></a>MosDNS</h2><blockquote>
<p>为了实现以上目标，我们需要一款 DNS 分流软件，它就是 MosDNS。</p>
</blockquote>
<p>我们通过以下命令进行安装，当前版本为 MosDNS v5.1.3：</p>
<ol>
<li>先升级必要工具：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install curl</span><br><span class="line">opkg update libcur</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行安装脚本：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c <span class="string">&quot;<span class="subst">$(curl -ksS https://raw.githubusercontent.com/sbwml/luci-app-mosdns/v5/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>安装成功之后，你会在【服务】-&gt;【MosDNS】找到。然后按照如图所示，关闭转发，打开自定义配置文件：   </p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/06.jpg" class="" width="700">

<p>我们添加以下配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">&quot;/opt/data/mosdns/mosdns.log&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#api:</span></span><br><span class="line">  <span class="comment">#http: &quot;0.0.0.0:9091&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="comment"># 缓存</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">cache</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">cache</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">10240</span></span><br><span class="line">      <span class="attr">lazy_cache_ttl:</span> <span class="number">86400</span></span><br><span class="line">      <span class="attr">dump_file:</span> <span class="string">/etc/mosdns/cache.dump</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 修改 ttl (默认 0 不修改 ttl)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">ttl_sequence</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">ttl</span> <span class="number">60</span><span class="number">-600</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">modify_response</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">jump</span> <span class="string">ttl_sequence</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">accept</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 有响应终止返回</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">has_response</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">has_resp</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">goto</span> <span class="string">modify_response</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="comment"># 黑名单 加入的域名将屏蔽 DNS 解析</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">blocklist</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">domain_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/mosdns/rule/blocklist.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># PTR 黑名单 加入的域名将阻止 PTR 请求</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">local_ptr</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">domain_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/mosdns/rule/local-ptr.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 白名单 由本地 DNS 负责解析（如果黑名单命中，则直接拒绝，也就是黑名单具有最高优先级）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">whitelist</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">domain_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/mosdns/rule/whitelist.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># DDNS 名单，加入的域名始终使用 &quot;本地 DNS&quot; 进行解析</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">ddnslist</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">domain_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/mosdns/rule/ddnslist.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 灰名单 加入的域名将仅使用 &quot;国外DNS服务器&quot; 进行解析</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">greylist</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">domain_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/mosdns/rule/greylist.txt&quot;</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="comment"># 自定义 Hosts 重写</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">hosts</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">hosts</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/mosdns/rule/hosts.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 重定向请求的域名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">redirect</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">redirect</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/mosdns/rule/redirect.txt&quot;</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="comment"># 国内域名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">geosite_cn</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">domain_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/var/mosdns/geosite_cn.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 国外域名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">geosite_no_cn</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">domain_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/var/mosdns/geosite_geolocation-!cn.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 国内 IP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">geoip_cn</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ip_set</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/var/mosdns/geoip_cn.txt&quot;</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="comment"># 国内 DNS 服务器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">forward_local</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">forward</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">concurrent:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">upstreams:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">dnsmasq</span></span><br><span class="line">          <span class="attr">addr:</span> <span class="string">&quot;udp://127.0.0.1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">alidns</span></span><br><span class="line">          <span class="attr">addr:</span> <span class="string">&quot;https://dns.alidns.com/dns-query&quot;</span></span><br><span class="line">          <span class="attr">dial_addr:</span> <span class="string">&quot;223.5.5.5&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">dnspod</span></span><br><span class="line">          <span class="attr">addr:</span> <span class="string">&quot;https://doh.pub/dns-query&quot;</span></span><br><span class="line">          <span class="attr">dial_addr:</span> <span class="string">&quot;1.12.12.12&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 国外 DNS 服务器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">forward_remote</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">forward</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">concurrent:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">upstreams:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">openClash</span></span><br><span class="line">          <span class="attr">addr:</span> <span class="string">&quot;udp://127.0.0.1:7874&quot;</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="comment"># 本地解析处理</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">local_resolve_sequence</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">$forward_local</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">jump</span> <span class="string">has_response</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 远程解析处理</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">remote_resolve_sequence</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">prefer_ipv4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">ecs</span> <span class="number">159.230</span><span class="number">.104</span><span class="number">.0</span><span class="string">/24</span> <span class="comment"># VPS 网段</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">$forward_remote</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">jump</span> <span class="string">has_response</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># fallback 用本地服务器 sequence 返回非国内 IP 则 drop_resp</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">query_is_cn_ip</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">$forward_local</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">jump</span> <span class="string">ttl_sequence</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">&quot;!resp_ip $geoip_cn&quot;</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">drop_resp</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># fallback 用远程服务器 sequence</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">query_is_remote</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">jump</span> <span class="string">remote_resolve_sequence</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">reject</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># fallback 用远程服务器 sequence</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">fallback</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">fallback</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">primary:</span> <span class="string">query_is_cn_ip</span></span><br><span class="line">      <span class="attr">secondary:</span> <span class="string">query_is_remote</span></span><br><span class="line">      <span class="attr">threshold:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">always_standby:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">main_sequence</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">sequence</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">qname</span> <span class="string">$local_ptr</span> <span class="string">$blocklist</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">reject</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">qtype</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">reject</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">qtype</span> <span class="number">65</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">reject</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">$hosts</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">has_resp</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">accept</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">$redirect</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">has_resp</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">accept</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">qname</span> <span class="string">$whitelist</span> <span class="string">$geosite_cn</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">$cache</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">has_resp</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">accept</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">qname</span> <span class="string">$whitelist</span> <span class="string">$ddnslist</span> <span class="string">$geosite_cn</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">jump</span> <span class="string">local_resolve_sequence</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matches:</span> <span class="string">qname</span> <span class="string">$greylist</span> <span class="string">$geosite_no_cn</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="string">jump</span> <span class="string">remote_resolve_sequence</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exec:</span> <span class="string">$fallback</span></span><br><span class="line">  <span class="comment">#--------------------------------------------------------------------#</span></span><br><span class="line">  <span class="comment"># 启动 udp 服务器。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">udp_server</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">udp_server</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">entry:</span> <span class="string">main_sequence</span></span><br><span class="line">      <span class="attr">listen:</span> <span class="string">&quot;:5335&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 启动 tcp 服务器。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">tcp_server</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">tcp_server</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">entry:</span> <span class="string">main_sequence</span></span><br><span class="line">      <span class="attr">listen:</span> <span class="string">&quot;:5335&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>MosDNS 选用的是 V5 的版本，如果你用的是 V4，那么两者配置文件不通用，这个要注意！</p>
</blockquote>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><blockquote>
<p>这里不会对 MosDNS 本身做详细的介绍，如果你想了解更多关于 MosDNS 的内容，请移步到 <a target="_blank" rel="noopener" href="https://irine-sistiana.gitbook.io/mosdns-wiki/">【wiki】</a>;</p>
</blockquote>
<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><p>DNS 部分，我们添加了 forward_local 跟 forward_remote 两个 DNS 插件，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 国内 DNS 服务器</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">forward_local</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">forward</span></span><br><span class="line">  <span class="attr">args:</span></span><br><span class="line">    <span class="attr">concurrent:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">upstreams:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">dnsmasq</span></span><br><span class="line">        <span class="attr">addr:</span> <span class="string">&quot;udp://127.0.0.1&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">alidns</span></span><br><span class="line">        <span class="attr">addr:</span> <span class="string">&quot;https://dns.alidns.com/dns-query&quot;</span></span><br><span class="line">        <span class="attr">dial_addr:</span> <span class="string">&quot;223.5.5.5&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">dnspod</span></span><br><span class="line">        <span class="attr">addr:</span> <span class="string">&quot;https://doh.pub/dns-query&quot;</span></span><br><span class="line">        <span class="attr">dial_addr:</span> <span class="string">&quot;1.12.12.12&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 国外 DNS 服务器</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">forward_remote</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">forward</span></span><br><span class="line">  <span class="attr">args:</span></span><br><span class="line">    <span class="attr">concurrent:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">upstreams:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">tag:</span> <span class="string">openClash</span></span><br><span class="line">        <span class="attr">addr:</span> <span class="string">&quot;udp://127.0.0.1:7874&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们将国内的 DNS 解析转发到 forward_local，将国外的 DNS 解析转移到 forward_remote。forward_local 中，我们配置了 3 个 DNS 地址，分别是本机、阿里、腾讯，为什么添加本机呢？其实本机 DNS 由 dnsmasq 负责解析，而 dnsmasq 会拿到运营商分配的地址，通常对本地 DNS 解析有 buff 加成。3 个 DNS 并发请求，取最快的作为响应。再补充一点，dnsmasq 监听的是 53 端口，MosDNS 监听的是 5335，所以 MosDNS 并不会影响 dnsmasq。那么你可能会有疑问，DNS 解析是如何被劫持到非标准端口 5335 的 MosDNS 的，不急，我们继续往下看。</p>
<p>forward_remote 负责国外 DNS 的解析，这里我们将它全权交由 OpenClash 处理。也就是说由 OpenClash 解析的请求都是要经过代理转发的。问题来了，经过国内 DNS 解析的请求还会被 OpenClash 转发吗？会！<br>其实对于请求劫持，OpenClash 做的还远不止这些，不过这是 OpenClash 专题要讲的事情。</p>
<h4 id="执行序列"><a href="#执行序列" class="headerlink" title="执行序列"></a>执行序列</h4><p>对于 local_ptr、blocklist 两个列表、qtype 12（PTR）、qtype 65（针对于 iOS 14）类型的解析会以 reject 3 也就是 NXDOMAIN 响应。对于 whitelist 白名单、geosite_cn 国内域名的请求先查询缓存，如果缓存不存在再进行国内 DNS 的解析（成功解析之后自动加入缓存）。这里我们并没有对 DDNS 及代理的解析做缓存，DDNS 由于会时常变更，并且它的访问频率比较低，所以也没有太大的必要加入缓存。而代理域名的解析由于 OpenClash 会直接返回 Fake-IP，OpenClash 自身就会做 Fake-IP 的持久化，所以就没有必要再做一次缓存了。毕竟，如果 Fake-IP 过期或者清理之后，缓存还生效，那么上网就会出现问题，并且 Fake-IP 并 不慢。</p>
<p>如果一个域名未匹配灰名单、国内规则，也未匹配 geosite_no_cn 属于三无域名，那么就要执行 fallback。首先会进行国内 DNS 解析拿到 IP，然后对该 IP 进行判断，如果符合国内则进行响应，否则丢弃交由国外 DNS 解析。</p>
<h4 id="名单"><a href="#名单" class="headerlink" title="名单"></a>名单</h4><p>整个配置文件已经把模板定好，我们可以直接通过面板来灵活定制我们的规则：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/07.jpg" class="" width="700">

<ul>
<li><p>白名单：</p>
<blockquote>
<p>白名单中的域名会走国内 DNS 解析。</p>
</blockquote>
</li>
<li><p>黑名单：</p>
<blockquote>
<p>用于屏蔽某个域名的解析。</p>
</blockquote>
</li>
<li><p>灰名单：</p>
<blockquote>
<p>需要走国外 DNS 解析的域名。</p>
</blockquote>
</li>
<li><p>DDNS 域名：</p>
<blockquote>
<p>如果存在 DDNS 域名，可以添加进来，由国内 DNS 解析。</p>
</blockquote>
</li>
</ul>
<p>最后一项就是需要打开数据库的定期更新：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/08.jpg" class="" width="700">


<h2 id="AdGuard-Home"><a href="#AdGuard-Home" class="headerlink" title="AdGuard Home"></a>AdGuard Home</h2><p>上文中，我们提到过 MosDNS 运行在 5335 端口，那么负责劫持 DNS 到 MosDNS 的就是 AdGuard Home 了。</p>
<ul>
<li><h3 id="AdGuard-Home-1"><a href="#AdGuard-Home-1" class="headerlink" title="AdGuard Home"></a>AdGuard Home</h3><p>AdGuard Home 将流量挟持到自己的 553 端口，我们可以通过配置 AdGuard Home 的【客户端配置】来指定接入的设备是否需要代理。</p>
<p>通过【设置】-&gt;【DNS 设置】指定它的上游 DNS 服务器为：<code>127.0.0.1:5335</code>，也就是 MosDNS 的监听端口。</p>
<p>通过【服务】-&gt;【AdGuard Home】，重定向 53 端口到 AdGuardHome 来劫持流量到自身。如下图：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/09.jpg" class="" width="700">

<p>AdGuard Home 基本设置就完成了，你也可以设置广告规则、敏感内容过滤等，本文就不对其展开了。</p>
</li>
</ul>
<h2 id="OpenClash-1"><a href="#OpenClash-1" class="headerlink" title="OpenClash"></a>OpenClash</h2><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><p>OpenClash 就是我们目标的最后一环节，我们需要按照如下步骤做好基础配置：</p>
<p>1、取消【绕过中国大陆 IP】</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/10.jpg" class="" width="700">

<p>2、本地 DNS 劫持停用</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/11.jpg" class="" width="700">

<p>3、勾选【自定义上游 DNS 服务器】，取消【追加上游 DN】、【追加默认 DNS】勾选，如下图：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/12.jpg" class="" width="700">

<p>4、移除 FallBack、default-NameServer 下的内容，并为 NameServer 添加国外 DNS 解析：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/13.jpg" class="" width="700">

<p>之所以要取消【追加上游 DNS】、【追加默认 DNS】是避免 OpenClash 将运营商分配的 DNS 添加进来，因为进入到 OpenClash 的流量一定是要走代理的，这些域名就不能被运营商的 DNS 解析。当你设置好之后一定要先【保存】，再【应用】。<br>否则配置不会生效，在应用之后，一定要去你的配置文件里看看最终生成的 DNS 是不是你指定的。</p>
<p>对于 Rule 部分，你可以配置成以下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">&quot;GEOIP,LAN,🇨🇳 China&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&quot;GEOIP,CN,🇨🇳 China&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&quot;MATCH,Proxy&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果命中大陆或者本地的 IP 那么走直连，其余走代理。</p>
<h3 id="请求劫持"><a href="#请求劫持" class="headerlink" title="请求劫持"></a>请求劫持</h3><p>到目前为止，好像该配的都配完了，国内的域名由 MosDNS 处理，国外的域名解析由 OpenClash 转发给 8.8.8.8 完成解析。此时其实只是完成了客户端到软路由的 DNS 解析，客户端拿到 DNS 解析记录之后会发送请求，如果只是以上的简单配置，那么流量会再次被 OpenClash 劫持。以下防火墙规则验证这一点：</p>
<img src="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/14.jpg" class="" width="700">

<p>我们看到源地址是 0.0.0.0/0 目标地址是 198.18.0.0/16、0.0.0.0/0 的流量都会转发到 7892 端口，也就是 OpenClash 代理端口。目标 198.18.0.0/16 为 Fake-IP 地址段，当客户端发起对该段的请求时，说明是需要代理的，所以这条规则没问题，但是下面一条规则就有问题了，我们需要将它移除：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -D openclash -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -j REDIRECT --to-ports 7892</span><br></pre></td></tr></table></figure>

<p>这样对于目标非 Fake-IP 的流量就不会流经 OpenClash 内核了。但是这会引发另外一个问题，我们知道有些 App 会直接发起对 IP 的请求，比如：Telegram，Netflix 等。该防火墙规则会导致这些流量直接走直连从而影响使用。怎么解决这个问题呢？<br>方法有二，我们可以根据它们的 CIDR 来选择流量劫持，但是不靠谱，因为还需要定期维护，一但对方更换，那么又会出现问题，比较被动。这里我们选择另外一个方案解决——利用 china ipset：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A openclash -p tcp -m set ! --match-set china_ip_route dst -j REDIRECT --to-ports 7892</span><br></pre></td></tr></table></figure>

<p>我们将目标地址非 China 的流量也转发到 OpenClash，就可以解决以上问题。还会有问题吗？答案是肯定的，除了客户端的请求外，宿主机也会产生请求，所以我们不得对这部分流量加以控制：</p>
<p>1、避免宿主机自身的出口流量全部走代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -D openclash_output -p tcp -m owner ! --uid-owner 65534 -j REDIRECT --to-ports 7892</span><br></pre></td></tr></table></figure>

<p>2、对于宿主机自身的 TCP 流量除了 Fake IP 外，对于非中国 IP 的流量且非 OpenClash 的出口流量也重定向到代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A openclash_output -p tcp -m set ! --match-set china_ip_route dst -m owner ! --uid-owner 65534 -j REDIRECT --to-ports 7892</span><br></pre></td></tr></table></figure>
<p>3、避免来自中国的 UDP 流量经过代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -D openclash -p udp -j TPROXY --tproxy-mark 0x162/0xffffffff --on-port 7895</span><br></pre></td></tr></table></figure>
<p>4、重定向非中国的 UDP 流量到代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A openclash -p udp -m set ! --match-set china_ip_route dst -j TPROXY --tproxy-mark 0x162/0xffffffff --on-port 7895</span><br></pre></td></tr></table></figure>

<p>以上关键的地方在于 <code>china_ip_route</code>，它包含了中国的 IP 段，所有根据 IP 的规则都要经过它来判断，那么如何生成 <code>china_ip_route</code> 便成了一个问题。其实 OpenClash 有自动更新 GEO 数据库及中国大陆白名单的定时任务，也就是说它会生成我们需要的 ipset 文件。<br>所以我们要做的就是添加以下命令，用于将 <code>china_ip_route</code> 文件转换成对应的 ipset：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipset -! flush china_ip_route</span><br><span class="line">ipset -! restore &lt;/etc/openclash/china_ip_route.ipset 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>最终我们将以下内容添加到【开发者选项】中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">. /usr/share/openclash/log.sh</span><br><span class="line">. /lib/functions.sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This script is called by /etc/init.d/openclash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Add your custom firewall rules here, they will be added after the end of the OpenClash iptables rules</span></span><br><span class="line"></span><br><span class="line">ipset -! flush china_ip_route</span><br><span class="line">ipset -! restore &lt;/etc/openclash/china_ip_route.ipset 2&gt;/dev/null</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 避免来自中国的流量经过代理，需要走代理的都保留了 Fake IP</span></span><br><span class="line">iptables -t nat -D openclash -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -j REDIRECT --to-ports 7892</span><br><span class="line"><span class="meta">#</span><span class="bash"> 避免宿主机自身的出口流量全部走代理</span></span><br><span class="line">iptables -t nat -D openclash_output -p tcp -m owner ! --uid-owner 65534 -j REDIRECT --to-ports 7892</span><br><span class="line"><span class="meta">#</span><span class="bash"> 避免来自中国的 UDP 流量经过代理</span></span><br><span class="line">iptables -t mangle -D openclash -p udp -j TPROXY --tproxy-mark 0x162/0xffffffff --on-port 7895</span><br><span class="line"><span class="meta">#</span><span class="bash"> 除 Fake IP 外，非中国 IP 的流量也重定向到代理</span></span><br><span class="line">iptables -t nat -A openclash -p tcp -m set ! --match-set china_ip_route dst -j REDIRECT --to-ports 7892</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重定向非中国的 UDP 流量到代理</span></span><br><span class="line">iptables -t mangle -A openclash -p udp -m set ! --match-set china_ip_route dst -j TPROXY --tproxy-mark 0x162/0xffffffff --on-port 7895</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于宿主机自身的 TCP 流量除了 Fake IP 外，对于非中国 IP 的流量且非 OpenClash 的出口流量也重定向到代理</span></span><br><span class="line">iptables -t nat -A openclash_output -p tcp -m set ! --match-set china_ip_route dst -m owner ! --uid-owner 65534 -j REDIRECT --to-ports 7892</span><br><span class="line"></span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure>

<p>保存、应用！</p>
<hr>
<h1 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h1><p>以上就是本次家庭网络改造的流程，最终可以实现，家中所有接入设备的实时管控。可以清楚的了解到每台设备的上网信息并对其加以限制。同时对于国内网的网站访问也可以做到精确分流，提升响应速度。当然这套方案也并不完美，由于国内域名跳过了 OpenClash 也就意味着失去了对它们的限制。不过可以从 DNS 维度对它们进行屏蔽。如果是基于 IP 的，那就只能通过防火墙加以限制了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/articles/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/articles/">1</a><a class="page-number" href="/articles/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/articles/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/articles/page/67/">67</a><a class="extend next" rel="next" href="/articles/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tubetrue01"
      src="/articles/img/head.PNG">
  <p class="site-author-name" itemprop="name">Tubetrue01</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/articles/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/articles/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Tubetrue01" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Tubetrue01" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/articles/Tubetrue01@gmail.com" title="E-Mail → Tubetrue01@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tubetrue01</span>
</div>



        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/articles/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="/articles/lib/velocity/velocity.min.js"></script>
  <script src="/articles/lib/velocity/velocity.ui.min.js"></script>

<script src="/articles/js/utils.js"></script>

<script src="/articles/js/motion.js"></script>


<script src="/articles/js/schemes/pisces.js"></script>


<script src="/articles/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  


    </div>
</body>
</html>
