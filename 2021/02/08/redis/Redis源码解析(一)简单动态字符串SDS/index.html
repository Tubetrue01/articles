<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/articles/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/articles/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/articles/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/articles/images/logo.svg" color="#222">

<link rel="stylesheet" href="/articles/css/main.css">


<link rel="stylesheet" href="/articles/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tubetrue01.github.io","root":"/articles/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å¼•è¨€ æœ¬ç³»åˆ—æ–‡ç« å¼€å§‹è®²è§£ Redis ç›¸å…³æºç ï¼Œæ–‡ç« ä¸å®šæ—¶æ›´æ–°ï¼Œå¹¶ä¸”å‘¨æœŸå¯èƒ½ä¼šå¾ˆé•¿ï¼Œè¯·å¤§å®¶è°…è§£ã€‚ä½œä¸ºç³»åˆ—æ–‡ç« çš„å¼€ç¯‡ï¼Œæˆ‘ä»¬ä»æœ€ç®€å•çš„æ•°æ®ç»“æ„ SDS å¼€å§‹è®²è§£ï¼Œæºç å–è‡ª 6.0.8 ç‰ˆæœ¬ã€‚  ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSimple Dynamic Stringsï¼ŒSDSï¼‰æ˜¯ Redis çš„åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œç”¨äºå­˜å‚¨å­—ç¬¦ä¸²å’Œæ•´å‹æ•°æ®ã€‚SDS å…¼å®¹ C è¯­è¨€æ ‡å‡†å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œä¸”åœ¨æ­¤åŸºç¡€ä¸Šä¿è¯äº†äºŒè¿›">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis æºç è§£æï¼ˆä¸€ï¼‰ç®€å•åŠ¨æ€å­—ç¬¦ä¸² SDS">
<meta property="og:url" content="https://tubetrue01.github.io/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/">
<meta property="og:site_name" content="Tubetrue01">
<meta property="og:description" content="å¼•è¨€ æœ¬ç³»åˆ—æ–‡ç« å¼€å§‹è®²è§£ Redis ç›¸å…³æºç ï¼Œæ–‡ç« ä¸å®šæ—¶æ›´æ–°ï¼Œå¹¶ä¸”å‘¨æœŸå¯èƒ½ä¼šå¾ˆé•¿ï¼Œè¯·å¤§å®¶è°…è§£ã€‚ä½œä¸ºç³»åˆ—æ–‡ç« çš„å¼€ç¯‡ï¼Œæˆ‘ä»¬ä»æœ€ç®€å•çš„æ•°æ®ç»“æ„ SDS å¼€å§‹è®²è§£ï¼Œæºç å–è‡ª 6.0.8 ç‰ˆæœ¬ã€‚  ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSimple Dynamic Stringsï¼ŒSDSï¼‰æ˜¯ Redis çš„åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œç”¨äºå­˜å‚¨å­—ç¬¦ä¸²å’Œæ•´å‹æ•°æ®ã€‚SDS å…¼å®¹ C è¯­è¨€æ ‡å‡†å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œä¸”åœ¨æ­¤åŸºç¡€ä¸Šä¿è¯äº†äºŒè¿›">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tubetrue01.github.io/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/01.png">
<meta property="og:image" content="https://tubetrue01.github.io/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/02.png">
<meta property="og:image" content="https://tubetrue01.github.io/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/03.png">
<meta property="og:image" content="https://tubetrue01.github.io/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/04.png">
<meta property="article:published_time" content="2021-02-08T07:38:03.000Z">
<meta property="article:modified_time" content="2021-09-30T07:29:46.000Z">
<meta property="article:author" content="Tubetrue01">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tubetrue01.github.io/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/01.png">

<link rel="canonical" href="https://tubetrue01.github.io/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Redis æºç è§£æï¼ˆä¸€ï¼‰ç®€å•åŠ¨æ€å­—ç¬¦ä¸² SDS | Tubetrue01</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/articles/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tubetrue01</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/articles/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/articles/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/articles/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://www.jianshu.com/u/46af180aa88f" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tubetrue01.github.io/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/articles/img/head.PNG">
      <meta itemprop="name" content="Tubetrue01">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tubetrue01">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis æºç è§£æï¼ˆä¸€ï¼‰ç®€å•åŠ¨æ€å­—ç¬¦ä¸² SDS
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-08 15:38:03" itemprop="dateCreated datePublished" datetime="2021-02-08T15:38:03+08:00">2021-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-09-30 15:29:46" itemprop="dateModified" datetime="2021-09-30T15:29:46+08:00">2021-09-30</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><blockquote>
<p>æœ¬ç³»åˆ—æ–‡ç« å¼€å§‹è®²è§£ Redis ç›¸å…³æºç ï¼Œæ–‡ç« ä¸å®šæ—¶æ›´æ–°ï¼Œå¹¶ä¸”å‘¨æœŸå¯èƒ½ä¼šå¾ˆé•¿ï¼Œè¯·å¤§å®¶è°…è§£ã€‚ä½œä¸ºç³»åˆ—æ–‡ç« çš„å¼€ç¯‡ï¼Œæˆ‘ä»¬ä»æœ€ç®€å•çš„æ•°æ®ç»“æ„ SDS å¼€å§‹è®²è§£ï¼Œæºç å–è‡ª 6.0.8 ç‰ˆæœ¬ã€‚</p>
</blockquote>
<h1 id="ç®€å•åŠ¨æ€å­—ç¬¦ä¸²"><a href="#ç®€å•åŠ¨æ€å­—ç¬¦ä¸²" class="headerlink" title="ç®€å•åŠ¨æ€å­—ç¬¦ä¸²"></a>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</h1><p>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSimple Dynamic Stringsï¼ŒSDSï¼‰æ˜¯ Redis çš„åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œç”¨äºå­˜å‚¨å­—ç¬¦ä¸²å’Œæ•´å‹æ•°æ®ã€‚SDS å…¼å®¹ C è¯­è¨€æ ‡å‡†å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œä¸”åœ¨æ­¤åŸºç¡€ä¸Šä¿è¯äº†äºŒè¿›åˆ¶å®‰å…¨ã€‚</p>
<ul>
<li><h2 id="äºŒè¿›åˆ¶å®‰å…¨"><a href="#äºŒè¿›åˆ¶å®‰å…¨" class="headerlink" title="äºŒè¿›åˆ¶å®‰å…¨"></a>äºŒè¿›åˆ¶å®‰å…¨</h2><p>ä»€ä¹ˆæ˜¯äºŒè¿›åˆ¶å®‰å…¨ï¼Ÿé€šä¿—åœ°è®²ï¼ŒC è¯­è¨€ä¸­ï¼Œç”¨ â€œ\0â€ è¡¨ç¤ºå­—ç¬¦ä¸²çš„ç»“æŸï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸­æœ¬èº«å°±æœ‰ â€œ\0â€ å­—ç¬¦ï¼Œå­—ç¬¦ä¸²å°±ä¼šè¢«æˆªæ–­ï¼Œå³éäºŒè¿›åˆ¶å®‰å…¨ï¼›è‹¥é€šè¿‡æŸç§æœºåˆ¶ï¼Œä¿è¯è¯»å†™å­—ç¬¦ä¸²æ—¶ä¸æŸå®³å…¶å†…å®¹ï¼Œåˆ™æ˜¯äºŒè¿›åˆ¶å®‰å…¨ã€‚</p>
</li>
<li><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>SDS æ—¢ç„¶æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆï¼›ä¸ºäº†æ–¹ä¾¿ä¸Šå±‚æ¥å£è°ƒç”¨ï¼Œè¯¥ç»“æ„è¿˜éœ€è¦è®°å½•ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚å½“å‰æ•°æ®é•¿åº¦å’Œå‰©ä½™å®¹é‡ç­‰ï¼Œå¦‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sds</span> &#123;</span> </span><br><span class="line">  <span class="keyword">int</span> len;     <span class="comment">// buf ä¸­å·²å ç”¨å­—èŠ‚æ•° </span></span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">free</span>;    <span class="comment">// buf ä¸­å‰©ä½™å¯ç”¨å­—èŠ‚æ•° </span></span><br><span class="line">  <span class="keyword">char</span> buf[];  <span class="comment">// æ•°æ®ç©ºé—´</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åœ¨ 64 ä½ç³»ç»Ÿä¸‹ï¼Œå­—æ®µ len å’Œå­—æ®µ free å„ å  4 ä¸ªå­—èŠ‚ï¼Œç´§æ¥ç€å­˜æ”¾å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™æ ·è®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ<br>####ä¼˜åŠ¿</p>
</li>
<li><p>æœ‰å•ç‹¬çš„ç»Ÿè®¡å˜é‡ len å’Œ freeï¼ˆç§°ä¸ºå¤´éƒ¨ï¼‰ã€‚å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¾—åˆ°å­—ç¬¦ä¸²é•¿åº¦ã€‚</p>
</li>
<li><p>å†…å®¹å­˜æ”¾åœ¨æŸ”æ€§æ•°ç»„ buf ä¸­ï¼ŒSDS å¯¹ä¸Šå±‚æš´éœ²çš„æŒ‡é’ˆä¸æ˜¯æŒ‡å‘ç»“æ„ä½“ SDS çš„æŒ‡é’ˆï¼Œè€Œæ˜¯ç›´æ¥æŒ‡å‘æŸ”æ€§æ•°ç»„ buf çš„æŒ‡é’ˆã€‚ä¸Šå±‚å¯åƒè¯»å– C å­—ç¬¦ä¸²ä¸€æ ·è¯»å– SDS çš„å†…å®¹ï¼Œå…¼å®¹ C è¯­è¨€å¤„ç†å­—ç¬¦ä¸²çš„å„ç§å‡½æ•°ã€‚</p>
</li>
<li><p>ç”±äºæœ‰é•¿åº¦ç»Ÿè®¡å˜é‡ len çš„å­˜åœ¨ï¼Œè¯»å†™å­—ç¬¦ä¸²æ—¶ä¸ä¾èµ– â€œ\0â€ ç»ˆæ­¢ç¬¦ï¼Œä¿è¯äº†äºŒè¿›åˆ¶å®‰å…¨ã€‚</p>
</li>
</ul>
<hr>
<img src="/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/01.png" class="" width="240">

<hr>
<p><strong>ğŸ“š Tips</strong></p>
<blockquote>
<p>ä¸Šä¾‹ä¸­çš„ buf[] æ˜¯ä¸€ä¸ªæŸ”æ€§æ•°ç»„ã€‚æŸ”æ€§æ•°ç»„æˆå‘˜ ï¼ˆflexible array memberï¼‰ï¼Œä¹Ÿå«ä¼¸ç¼©æ€§æ•°ç»„æˆå‘˜ï¼Œåªèƒ½è¢«æ”¾åœ¨ç»“æ„ä½“çš„æœ«å°¾ã€‚åŒ…å«æŸ”æ€§æ•°ç»„æˆå‘˜çš„ç»“æ„ä½“ï¼Œé€šè¿‡ malloc å‡½æ•°ä¸ºæŸ”æ€§æ•°ç»„åŠ¨æ€åˆ†é…å†…å­˜ã€‚ä¹‹æ‰€ä»¥ç”¨æŸ”æ€§æ•°ç»„å­˜æ”¾å­—ç¬¦ä¸²ï¼Œæ˜¯å› ä¸ºæŸ”æ€§æ•°ç»„çš„åœ°å€å’Œç»“æ„ä½“ æ˜¯è¿ç»­çš„ï¼Œè¿™æ ·æŸ¥æ‰¾å†…å­˜æ›´å¿«ï¼ˆå› ä¸ºä¸éœ€è¦é¢å¤–é€šè¿‡æŒ‡é’ˆæ‰¾åˆ°å­—ç¬¦ä¸² çš„ä½ç½®ï¼‰ï¼›å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡æŸ”æ€§æ•°ç»„çš„é¦–åœ°å€åç§»å¾—åˆ°ç»“æ„ä½“é¦–åœ° å€ï¼Œè¿›è€Œèƒ½å¾ˆæ–¹ä¾¿åœ°è·å–å…¶ä½™å˜é‡ã€‚</p>
</blockquote>
<h4 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h4><p>æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæœ€åŸºæœ¬çš„åŠ¨æ€å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¯¥ç»“æ„æ˜¯å¦æœ‰æ”¹è¿›çš„ç©ºé—´å‘¢ï¼Ÿæˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„é—®é¢˜å¼€å§‹æ€è€ƒï¼šä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²æ˜¯å¦æœ‰å¿…è¦å ç”¨ç›¸åŒå¤§å°çš„å¤´éƒ¨ï¼Ÿä¸€ä¸ª int å  4 å­—èŠ‚ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå­˜æ”¾äº Redis ä¸­çš„å­—ç¬¦ä¸²å¾€å¾€æ²¡æœ‰è¿™ä¹ˆé•¿ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²éƒ½ç”¨ 4 å­—èŠ‚å­˜å‚¨æœªå…å¤ªæµªè´¹ç©ºé—´äº†ã€‚æˆ‘ä»¬è€ƒè™‘ä¸‰ç§æƒ…å†µï¼šçŸ­å­—ç¬¦ä¸²ï¼Œlen å’Œ free çš„é•¿åº¦ä¸º 1 å­—èŠ‚å°±å¤Ÿäº†ï¼›é•¿å­—ç¬¦ä¸²ï¼Œç”¨ 2 å­—èŠ‚æˆ– 4 å­—èŠ‚ï¼›æ›´é•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨ 8 å­—èŠ‚ã€‚è¿™æ ·ç¡®å®æ›´çœå†…å­˜ï¼Œä½†ä¾ç„¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>å¦‚ä½•åŒºåˆ†è¿™ 3 ç§æƒ…å†µï¼Ÿ</li>
<li>å¯¹äºçŸ­å­—ç¬¦ä¸²æ¥è¯´ï¼Œå¤´éƒ¨è¿˜æ˜¯å¤ªé•¿äº†ã€‚ä»¥é•¿åº¦ä¸º 1 å­—èŠ‚çš„å­—ç¬¦ä¸²ä¸ºä¾‹ï¼Œlen å’Œ free æœ¬èº«å°±å äº† 2 ä¸ªå­—èŠ‚ï¼Œèƒ½ä¸èƒ½è¿›ä¸€æ­¥å‹ç¼©å‘¢ï¼Ÿ</li>
</ol>
<p>å¯¹äºé—®é¢˜ 1ï¼Œæˆ‘ä»¬è€ƒè™‘å¢åŠ ä¸€ä¸ªå­—æ®µ flags æ¥æ ‡è¯†ç±»å‹ï¼Œç”¨æœ€å°çš„ 1 å­—èŠ‚æ¥å­˜å‚¨ï¼Œä¸”æŠŠ flags åŠ åœ¨æŸ”æ€§æ•°ç»„ buf ä¹‹å‰ï¼Œè¿™æ ·è™½ç„¶å¤šäº†1 å­—èŠ‚ï¼Œ ä½†é€šè¿‡åç§»æŸ”æ€§æ•°ç»„çš„æŒ‡é’ˆå³èƒ½å¿«é€Ÿå®šä½ flagsï¼ŒåŒºåˆ†ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ¥å—ï¼›å¯¹äºé—®é¢˜ 2ï¼Œç”±äºlenå·²ç»æ˜¯æœ€å°çš„1å­—èŠ‚äº†ï¼Œå†å‹ç¼©åªèƒ½è€ƒè™‘ç”¨ä½æ¥å­˜å‚¨é•¿åº¦äº†ã€‚<br>ç»“åˆä¸¤ä¸ªé—®é¢˜ï¼Œ5 ç§ç±»å‹ï¼ˆé•¿åº¦ 1 å­—èŠ‚ã€2 å­—èŠ‚ã€4 å­—èŠ‚ã€8 å­—èŠ‚ã€ å°äº 1 å­—èŠ‚ï¼‰çš„ SDS è‡³å°‘è¦ç”¨ 3 ä½æ¥å­˜å‚¨ç±»å‹ï¼ˆ2 ^ 3 ï¼8ï¼‰ï¼Œ1 ä¸ªå­—èŠ‚ 8 ä½ï¼Œå‰©ä½™çš„ 5 ä½å­˜å‚¨é•¿åº¦ï¼Œå¯ä»¥æ»¡è¶³é•¿åº¦å°äº 32 çš„çŸ­å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬ç”¨å¦‚ä¸‹ç»“æ„æ¥å­˜å‚¨é•¿åº¦å°äº 32 çš„çŸ­å­—ç¬¦ä¸²ï¼š</p>
<p>sds.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* ä½ 3 ä½å­˜å‚¨ç±»å‹, é«˜ 5 ä½å­˜å‚¨é•¿åº¦ */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>sdshdr5 ç»“æ„ä¸­ï¼Œflags å  1 ä¸ªå­—èŠ‚ï¼Œå…¶ä½ 3 ä½ï¼ˆbitï¼‰è¡¨ç¤º typeï¼Œé«˜ 5 ä½ï¼ˆbitï¼‰è¡¨ç¤ºé•¿åº¦ï¼Œèƒ½è¡¨ç¤ºçš„é•¿åº¦åŒºé—´ä¸º 0ï½31ï¼ˆ2^5 -1ï¼‰ï¼Œ flags åé¢å°±æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹ã€‚<br><strong>Tips</strong></p>
<blockquote>
<p>__attribute__ ((__packed__)) çš„ä½œç”¨å°±æ˜¯é¿å…ç¼–è¯‘å™¨è¿›è¡Œå­—èŠ‚å¯¹é½ä¼˜åŒ–ï¼Œé‡‡ç”¨å®é™…çš„å­—èŠ‚å¯¹é½ã€‚ è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯èŠ‚çœå†…å­˜ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡æŒ‡é’ˆçµæ´»çš„è·å–å„ä¸ªå­—æ®µçš„åœ°å€ï¼ˆå¦‚æœå¯¹é½ä¼˜åŒ–äº†ï¼Œé‚£ä¹ˆæŒ‡é’ˆå¯èƒ½è·å–åˆ°å¡«å……çš„åœ°å€ç©ºé—´ï¼‰ã€‚</p>
</blockquote>
<hr>
<img src="/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/02.png" class="" width="540">

<hr>
<p>è€Œé•¿åº¦å¤§äº 31 çš„å­—ç¬¦ä¸²ï¼Œ1 ä¸ªå­—èŠ‚ä¾ç„¶å­˜ä¸ä¸‹ã€‚æˆ‘ä»¬æŒ‰ä¹‹å‰çš„æ€è·¯ï¼Œå°† len å’Œ free å•ç‹¬å­˜æ”¾ã€‚sdshdr8ã€sdshdr16ã€sdshdr32 å’Œ sdshdr64 çš„ç»“æ„ç›¸åŒï¼Œsdshdr16 ç»“æ„å¦‚å›¾æ‰€ç¤ºã€‚</p>
<hr>
<img src="/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/03.png" class="" width="540">

<hr>
<p>å…¶ä¸­â€œè¡¨å¤´â€å…±å ç”¨äº† S[2(len) + 2(alloc) + 1(flags)] ä¸ªå­—èŠ‚ã€‚flags çš„å†…å®¹ä¸ sdshdr5 ç±»ä¼¼ï¼Œä¾ç„¶é‡‡ç”¨ 3 ä½å­˜å‚¨ç±»å‹ï¼Œä½†å‰©ä½™ 5 ä½ä¸å­˜å‚¨é•¿åº¦ã€‚<br>åœ¨ Redis çš„æºä»£ç ä¸­ï¼Œå¯¹ç±»å‹çš„å®å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>sds.h</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">define SDS_TYPE_5  0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">define SDS_TYPE_8  1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">define SDS_TYPE_16 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">define SDS_TYPE_32 3</span></span><br><span class="line"><span class="meta">#</span><span class="bash">define SDS_TYPE_64 4</span></span><br></pre></td></tr></table></figure>
<p>sdshdr8ã€sdshdr16ã€sdshdr32 å’Œ sdshdr64 çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<p>sds.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len;          <span class="comment">/* å·²ç”¨çš„é•¿åº¦ */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc;        <span class="comment">/* æ€»çš„é•¿åº¦ */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags;  <span class="comment">/* ä½ 3 ä¸ºä»£è¡¨ç±»å‹ï¼Œé«˜ 5 ä½æœªä½¿ç”¨ */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> len;  </span><br><span class="line">    <span class="keyword">uint16_t</span> alloc;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; </span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> len; </span><br><span class="line">    <span class="keyword">uint32_t</span> alloc; </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; </span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> len; </span><br><span class="line">    <span class="keyword">uint64_t</span> alloc; </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; </span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ 4 ç§ç»“æ„çš„æˆå‘˜å˜é‡ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ len å’Œ alloc çš„ç±»å‹ä¸åŒã€‚ç»“æ„ä½“ä¸­ 4 ä¸ªå­—æ®µçš„å…·ä½“å«ä¹‰åˆ†åˆ«å¦‚ä¸‹ã€‚</p>
<ul>
<li>len ï¼šè¡¨ç¤º buf ä¸­å·²å ç”¨å­—èŠ‚æ•°ã€‚</li>
<li>alloc ï¼šè¡¨ç¤ºbufä¸­å·²åˆ†é…å­—èŠ‚æ•°ï¼Œä¸åŒäº freeï¼Œè®°å½•çš„æ˜¯ä¸º buf åˆ†é…çš„æ€»é•¿åº¦ã€‚</li>
<li>flags ï¼šæ ‡è¯†å½“å‰ç»“æ„ä½“çš„ç±»å‹ï¼Œä½ 3 ä½ç”¨ä½œæ ‡è¯†ä½ï¼Œé«˜ 5 ä½é¢„ç•™ã€‚</li>
<li>buf ï¼šæŸ”æ€§æ•°ç»„ï¼ŒçœŸæ­£å­˜å‚¨å­—ç¬¦ä¸²çš„æ•°æ®ç©ºé—´ã€‚</li>
</ul>
<h1 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h1><p>æ•°æ®ç»“æ„çš„åŸºæœ¬æ“ä½œä¸å¤–ä¹å¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼ŒSDS ä¹Ÿä¸ä¾‹å¤–ã€‚</p>
<ul>
<li><h2 id="å®"><a href="#å®" class="headerlink" title="å®"></a>å®</h2>c å‡½æ•°ä¸­å¾ˆå¤§ä¸€éƒ¨åˆ†ç”¨åˆ°äº†å®è¿ç®—ï¼Œè¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹ç›¸å…³çš„å®ä»¥åŠå¸¸é‡<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sds æ˜¯ char ç±»å‹çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *sds;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹æ©ç ï¼ŒæŒ‰ä½ä¸å¯æ±‚å‡ºå¯¹åº”çš„æ•°æ®ç±»å‹</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_TYPE_MASK 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ– sh æŒ‡é’ˆï¼Œè®© sh æŒ‡å‘å¯¹åº”ç»“æ„ä½“çš„é¦–åœ°å€ã€‚T å°±æ˜¯å¯¹åº”çš„ç»“æ„ä½“ç±»å‹ï¼Œs æ˜¯æŒ‡å‘ buf çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T)));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ SDS_HDR_VAR ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™é‡Œè¿”å›çš„æ˜¯ç»“æ„å¯¹è±¡ï¼Œéœ€è¦ &quot;SDS_HDR(T,s) -&gt; len &quot;æ–¹å¼ä½¿ç”¨</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1M å†…å­˜åˆ†é…é‡</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDS_MAX_PREALLOC (1024*1024)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li><h2 id="åˆ›å»ºå­—ç¬¦ä¸²"><a href="#åˆ›å»ºå­—ç¬¦ä¸²" class="headerlink" title="åˆ›å»ºå­—ç¬¦ä¸²"></a>åˆ›å»ºå­—ç¬¦ä¸²</h2>Redis é€šè¿‡ sdsnewlen å‡½æ•°åˆ›å»º SDSã€‚åœ¨å‡½æ•°ä¸­ä¼šæ ¹æ®å­—ç¬¦ä¸²é•¿åº¦é€‰æ‹©åˆé€‚çš„ç±»å‹ï¼Œåˆå§‹åŒ–å®Œç›¸åº”çš„ç»Ÿè®¡å€¼åï¼Œè¿”å›æŒ‡å‘å­—ç¬¦ä¸²å†…å®¹çš„æŒ‡é’ˆï¼Œæ ¹æ®å­—ç¬¦ä¸²é•¿åº¦é€‰æ‹©ä¸åŒçš„ç±»å‹ï¼š</li>
</ul>
<p>sds.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * init æŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œinitlen å­—ç¬¦ä¸²çš„é•¿åº¦ï¼›å¦‚ï¼š</span></span><br><span class="line"><span class="comment"> * mystring = sdsnewlen(&quot;abc&quot;,3); </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">sds <span class="title">sdsnewlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *init, <span class="keyword">size_t</span> initlen)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">void</span> *sh;</span><br><span class="line">    sds s;</span><br><span class="line">    <span class="comment">// æ ¹æ®åˆå§‹å¤§å°è·å–å¯¹åº”çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">char</span> type = sdsReqType(initlen);</span><br><span class="line">    <span class="comment">// SDS_TYPE_5 ç±»å‹ä¼šè½¬æ¢æˆ SDS_TYPE_8 </span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5 &amp;&amp; initlen == <span class="number">0</span>) type = SDS_TYPE_8;</span><br><span class="line">    <span class="comment">// æ ¹æ®ç±»å‹è®¡ç®—å‡ºè¯¥ç»“æ„å¯¹åº”çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">int</span> hdrlen = sdsHdrSize(type);</span><br><span class="line">    <span class="comment">// æŒ‡å‘ flags æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *fp;</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * åˆ†é…å†…å­˜ï¼Œå†…å­˜å¤§å°åŒ…æ‹¬ï¼šç»“æ„è‡ªèº«å ç”¨çš„å†…å­˜ + æ•°æ®å­˜å‚¨çš„å†…å­˜ + 1 * å­—èŠ‚çš„ &#x27;\0&#x27;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    sh = s_malloc(hdrlen+initlen+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// å†…å­˜åˆ†é…å¤±è´¥è¿”å› NULL</span></span><br><span class="line">    <span class="keyword">if</span> (sh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (init == SDS_NOINIT)</span><br><span class="line">        init = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!init)</span><br><span class="line">        <span class="comment">// å¼€å§‹åˆå§‹åŒ–å†…å­˜</span></span><br><span class="line">        <span class="built_in">memset</span>(sh, <span class="number">0</span>, hdrlen+initlen+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// æ­¤æ—¶ s æŒ‡å‘äº† bufï¼ˆsh æ˜¯å†…å­˜çš„é¦–åœ°å€ï¼Œhdrlen æ˜¯ç»“æ„ä½“å¤§å°ï¼Œæ³¨æ„è¿™é‡Œçš„æŒ‡é’ˆè½¬æ¢ï¼‰</span></span><br><span class="line">    s = (<span class="keyword">char</span>*)sh+hdrlen;</span><br><span class="line">    <span class="comment">// ç”±äºå†…å­˜æ˜¯ç´§å‡‘çš„ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥ç®—å‡º flags çš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ fp æŒ‡å‘äº† flags</span></span><br><span class="line">    fp = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)s)<span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// é€šè¿‡ type çš„ç±»å‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™ flags èµ‹å€¼äº†</span></span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5: &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œä¸ç”¨è¿‡å¤šä»‹ç»ï¼ŒæŒ‰ä½æˆ–ç®—å‡ºé«˜ä½ä½</span></span><br><span class="line">            *fp = type | (initlen &lt;&lt; SDS_TYPE_BITS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8: &#123;</span><br><span class="line">            <span class="comment">// è¿™æ­¥åœ¨åšä»€ä¹ˆï¼ŸSDS_HDR_VAR å…¶å®æ˜¯ä¸€ä¸ªå®ï¼Œè¯¥æ­¥çš„æ“ä½œå°±æ˜¯åˆå§‹åŒ– shï¼Œå°† sh æŒ‡é’ˆå¼ºåˆ¶è½¬æ¢æˆå¯¹åº”çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œå› ä¸º sh èµ·åˆæ˜¯ void * æŒ‡é’ˆï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡æŒ‡é’ˆè®¿é—®å…¶æˆå‘˜ã€‚é€šè¿‡ç»“æ„ä½“å¤§å°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ä»¥åŠåˆ†é…çš„å†…å­˜å¤§å°ï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰å¯ä»¥æ¨ç®—å‡ºç»“æ„ä½“é¦–åœ°å€</span></span><br><span class="line">            SDS_HDR_VAR(<span class="number">8</span>,s);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ– len æˆå‘˜</span></span><br><span class="line">            sh-&gt;len = initlen;</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ– alloc æˆå‘˜</span></span><br><span class="line">            sh-&gt;alloc = initlen;</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ– flag</span></span><br><span class="line">            *fp = type;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_16: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">16</span>,s);</span><br><span class="line">            sh-&gt;len = initlen;</span><br><span class="line">            sh-&gt;alloc = initlen;</span><br><span class="line">            *fp = type;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_32: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">32</span>,s);</span><br><span class="line">            sh-&gt;len = initlen;</span><br><span class="line">            sh-&gt;alloc = initlen;</span><br><span class="line">            *fp = type;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_64: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">64</span>,s);</span><br><span class="line">            sh-&gt;len = initlen;</span><br><span class="line">            sh-&gt;alloc = initlen;</span><br><span class="line">            *fp = type;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (initlen &amp;&amp; init)</span><br><span class="line">        <span class="comment">// å°† init æŒ‡å‘çš„å­—ç¬¦ä¸²èµ‹å€¼åˆ° s ä¸­ï¼ˆä¹Ÿå°±æ˜¯ bufï¼‰</span></span><br><span class="line">        <span class="built_in">memcpy</span>(s, init, initlen);</span><br><span class="line">    <span class="comment">// ä¸è¦å¿˜è®°æœ«å°¾çš„ &#x27;\0&#x27;</span></span><br><span class="line">    s[initlen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="comment">// è¿”å›å­—ç¬¦ä¸²åœ°å€ï¼Œå³ buf åœ°å€</span></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®å­—ç¬¦ä¸²çš„å¤§å°è¿”å›å…¶å¯¹åº”çš„ SDS ç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">char</span> <span class="title">sdsReqType</span><span class="params">(<span class="keyword">size_t</span> string_size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1</span>&lt;&lt;<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_5;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1</span>&lt;&lt;<span class="number">8</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_8;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1</span>&lt;&lt;<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_16;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (LONG_MAX == LLONG_MAX)</span></span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1ll</span>&lt;&lt;<span class="number">32</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_32;</span><br><span class="line">    <span class="keyword">return</span> SDS_TYPE_64;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> SDS_TYPE_32;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>ğŸ“š Tips</strong></p>
<blockquote>
<p>Redis 3.2 åçš„ SDS ç»“æ„ç”± 1 ç§å¢è‡³ 5 ç§ï¼Œä¸”å¯¹äº sdshdr5  ç±»å‹ï¼Œåœ¨åˆ›å»ºç©ºå­—ç¬¦ä¸²æ—¶ä¼šå¼ºåˆ¶è½¬æ¢ä¸º sdshdr8ã€‚åŸå› å¯èƒ½æ˜¯åˆ›å»ºç©º å­—ç¬¦ä¸²åï¼Œå…¶å†…å®¹å¯èƒ½ä¼šé¢‘ç¹æ›´æ–°è€Œå¼•å‘æ‰©å®¹ï¼Œæ•…åˆ›å»ºæ—¶ç›´æ¥åˆ›å»ºä¸º sdshdr8ã€‚</p>
</blockquote>
<p>ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶å® s å°±æ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Œå³ç»“æ„ä¸­çš„ bufã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„åœ¨äºç›´æ¥å¯¹ä¸Šå±‚æä¾›äº†å­—ç¬¦ä¸²å†…å®¹æŒ‡é’ˆï¼Œå…¼å®¹äº†éƒ¨åˆ† C å‡½æ•°ï¼Œä¸”é€šè¿‡åç§»èƒ½è¿…é€Ÿå®šä½åˆ° SDS ç»“æ„ä½“çš„å„å¤„æˆå‘˜å˜é‡ã€‚</p>
<ul>
<li><h2 id="é‡Šæ”¾å­—ç¬¦ä¸²"><a href="#é‡Šæ”¾å­—ç¬¦ä¸²" class="headerlink" title="é‡Šæ”¾å­—ç¬¦ä¸²"></a>é‡Šæ”¾å­—ç¬¦ä¸²</h2><p>SDS æä¾›äº†ç›´æ¥é‡Šæ”¾å†…å­˜çš„æ–¹æ³•â€”â€”sdsfreeï¼Œè¯¥æ–¹æ³•é€šè¿‡å¯¹ s çš„åç§»ï¼Œå¯å®šä½åˆ° SDS ç»“æ„ä½“çš„é¦–éƒ¨ï¼Œç„¶åè°ƒç”¨ s_free é‡Šæ”¾å†…å­˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfree</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå­—ç¬¦ä¸²ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// ç›´æ¥é‡Šæ”¾å†…å­˜ï¼Œs[-1] æŒ‡å‘çš„æ˜¯ flagï¼Œs - flag å¾—å‡ºçš„å°±æ˜¯å†…å­˜çš„é¦–åœ°å€</span></span><br><span class="line">    s_free((<span class="keyword">char</span>*)s-sdsHdrSize(s[<span class="number">-1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ç±»å‹è·å–å¯¹åº”çš„ç»“æ„ä½“å†…å­˜å¤§å°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">sdsHdrSize</span><span class="params">(<span class="keyword">char</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(type&amp;SDS_TYPE_MASK) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">sizeof</span>(struct sdshdr5);</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">sizeof</span>(struct sdshdr8);</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_16:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">sizeof</span>(struct sdshdr16);</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_32:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">sizeof</span>(struct sdshdr32);</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_64:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">sizeof</span>(struct sdshdr64);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼ˆå‡å°‘ç”³è¯·å†…å­˜çš„å¼€é”€ï¼‰ï¼ŒSDS æä¾›äº†ä¸ç›´æ¥é‡Šæ”¾ å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡é‡ç½®ç»Ÿè®¡å€¼è¾¾åˆ°æ¸…ç©ºç›®çš„çš„æ–¹æ³•â€”â€”sdsclearã€‚è¯¥æ–¹ æ³•ä»…å°† SDS çš„ len å½’é›¶ï¼Œæ­¤å¤„å·²å­˜åœ¨çš„ buf å¹¶æ²¡æœ‰çœŸæ­£è¢«æ¸…é™¤ï¼Œæ–°çš„æ•° æ®å¯ä»¥è¦†ç›–å†™ï¼Œè€Œä¸ç”¨é‡æ–°ç”³è¯·å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsclear</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°† len è®¾ç½®æˆ 0</span></span><br><span class="line">    sdssetlen(s, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// buf é¦–ä½è®¾ç½®æˆ &#x27;\0&#x27;</span></span><br><span class="line">    s[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°† len å±æ€§è®¾ç½®æˆ newlen å¯¹åº”çš„å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">sdssetlen</span><span class="params">(sds s, <span class="keyword">size_t</span> newlen)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å– flags å€¼</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags = s[<span class="number">-1</span>];</span><br><span class="line">    <span class="keyword">switch</span>(flags&amp;SDS_TYPE_MASK) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// è·å– fp æŒ‡é’ˆ</span></span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">char</span> *fp = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)s)<span class="number">-1</span>;</span><br><span class="line">                *fp = SDS_TYPE_5 | (newlen &lt;&lt; SDS_TYPE_BITS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8:</span><br><span class="line">            SDS_HDR(<span class="number">8</span>,s)-&gt;len = newlen;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_16:</span><br><span class="line">            SDS_HDR(<span class="number">16</span>,s)-&gt;len = newlen;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_32:</span><br><span class="line">            SDS_HDR(<span class="number">32</span>,s)-&gt;len = newlen;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_64:</span><br><span class="line">            SDS_HDR(<span class="number">64</span>,s)-&gt;len = newlen;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><h2 id="æ‹¼æ¥å­—ç¬¦ä¸²"><a href="#æ‹¼æ¥å­—ç¬¦ä¸²" class="headerlink" title="æ‹¼æ¥å­—ç¬¦ä¸²"></a>æ‹¼æ¥å­—ç¬¦ä¸²</h2><p>æ‹¼æ¥å­—ç¬¦ä¸²æ“ä½œæœ¬èº«ä¸å¤æ‚ï¼Œå¯ç”¨ sdscatsds æ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨æ„ const</span></span><br><span class="line"><span class="function">sds <span class="title">sdscatsds</span><span class="params">(sds s, <span class="keyword">const</span> sds t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sdscatlen(s, t, sdslen(t));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sdscatsds æ˜¯æš´éœ²ç»™ä¸Šå±‚çš„æ–¹æ³•ï¼Œå…¶æœ€ç»ˆè°ƒç”¨çš„æ˜¯ sdscatlenã€‚ç”±äºå…¶ä¸­å¯èƒ½æ¶‰åŠ SDS çš„æ‰©å®¹ï¼Œsdscatlen ä¸­è°ƒç”¨ sdsMakeRoomFor å¯¹å¸¦æ‹¼æ¥çš„å­—ç¬¦ä¸² s å®¹é‡åšæ£€æŸ¥ï¼Œè‹¥æ— é¡»æ‰©å®¹åˆ™ç›´æ¥è¿”å› sï¼›è‹¥éœ€è¦æ‰©å®¹ï¼Œåˆ™è¿”å›æ‰©å®¹å¥½çš„æ–°å­—ç¬¦ä¸² sã€‚å‡½æ•°ä¸­çš„ lenã€curlen ç­‰é•¿åº¦å€¼æ˜¯ä¸å«ç»“æŸç¬¦çš„ï¼Œè€Œæ‹¼æ¥æ—¶ç”¨ memcpy å°†ä¸¤ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥åœ¨ä¸€èµ·ï¼ŒæŒ‡å®šäº†ç›¸å…³é•¿åº¦ï¼Œæ•…è¯¥è¿‡ç¨‹ä¿è¯äº†äºŒè¿›åˆ¶å®‰å…¨ã€‚æœ€åéœ€è¦åŠ ä¸Šç»“æŸç¬¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å°†æŒ‡é’ˆ t çš„å†…å®¹å’ŒæŒ‡é’ˆ s çš„å†…å®¹æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œè¯¥æ“ä½œæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ */</span> </span><br><span class="line"><span class="function">sds <span class="title">sdscatlen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">void</span> *t, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®— s å¯¹åº”çš„ len å±æ€§</span></span><br><span class="line">    <span class="keyword">size_t</span> curlen = sdslen(s);</span><br><span class="line">    <span class="comment">// æ ¹æ® s ä»¥åŠ len é€‰æ‹©åˆé€‚çš„æ‰©å®¹ç­–ç•¥</span></span><br><span class="line">    s = sdsMakeRoomFor(s,len);</span><br><span class="line">    <span class="comment">// æ‰©å®¹å¤±è´¥ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// å°† t ä¸­çš„ len é•¿åº¦çš„å†…å®¹å¤åˆ¶åˆ° s + curlen æŒ‡å‘çš„å†…å­˜åœ°å€</span></span><br><span class="line">    <span class="built_in">memcpy</span>(s+curlen, t, len);</span><br><span class="line">    <span class="comment">// æ›´æ–° s ä¸­çš„ len å±æ€§</span></span><br><span class="line">    sdssetlen(s, curlen+len);</span><br><span class="line">    <span class="comment">// åœ¨ buf çš„æœ«å°¾æ·»åŠ ç»“æŸç¬¦</span></span><br><span class="line">    s[curlen+len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€šè¿‡ sï¼ˆå³ buf åœ°å€ï¼‰ï¼Œè·å–è¯¥ç»“æ„å¯¹åº”çš„ len å±æ€§</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">size_t</span> <span class="title">sdslen</span><span class="params">(<span class="keyword">const</span> sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags = s[<span class="number">-1</span>];</span><br><span class="line">    <span class="keyword">switch</span>(flags&amp;SDS_TYPE_MASK) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5:</span><br><span class="line">            <span class="keyword">return</span> SDS_TYPE_5_LEN(flags);</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">8</span>,s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_16:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">16</span>,s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_32:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">32</span>,s)-&gt;len;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_64:</span><br><span class="line">            <span class="keyword">return</span> SDS_HDR(<span class="number">64</span>,s)-&gt;len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰©å®¹æ–¹æ³•ï¼Œs å¾…æ‰©å®¹çš„ bufï¼Œaddlen æ˜¯ç›®æ ‡å­—ç¬¦ä¸²å†…å­˜å¤§å°</span></span><br><span class="line"><span class="function">sds <span class="title">sdsMakeRoomFor</span><span class="params">(sds s, <span class="keyword">size_t</span> addlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh, *newsh;</span><br><span class="line">    <span class="comment">// ç®—å‡º s ä¸­å¯ç”¨å†…å­˜ï¼ˆalloc - lenï¼‰</span></span><br><span class="line">    <span class="keyword">size_t</span> avail = sdsavail(s);</span><br><span class="line">    <span class="keyword">size_t</span> len, newlen;</span><br><span class="line">    <span class="keyword">char</span> type, oldtype = s[<span class="number">-1</span>] &amp; SDS_TYPE_MASK;</span><br><span class="line">    <span class="keyword">int</span> hdrlen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå‰©ä½™ç©ºé—´è¶³å¤Ÿå®¹çº³ç›®æ ‡å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› s</span></span><br><span class="line">    <span class="keyword">if</span> (avail &gt;= addlen) <span class="keyword">return</span> s;</span><br><span class="line">    <span class="comment">// è·å– s ä¸­çš„ len</span></span><br><span class="line">    len = sdslen(s);</span><br><span class="line">    <span class="comment">// sh æŒ‡å‘åŸå§‹ s çš„ç»“æ„é¦–åœ°å€</span></span><br><span class="line">    sh = (<span class="keyword">char</span>*)s-sdsHdrSize(oldtype);</span><br><span class="line">    </span><br><span class="line">    newlen = (len+addlen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ–°å¢ä¹‹åçš„å†…å­˜å¤§å° &lt; 1Mï¼Œé‚£ä¹ˆé‡‡ç”¨ 2 å€å†…å­˜æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (newlen &lt; SDS_MAX_PREALLOC)</span><br><span class="line">        newlen *= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       <span class="comment">// å¦‚æœ &gt; 1Mï¼Œé‚£ä¹ˆä»¥ 1M çš„å†…å­˜å¢é‡æ‰©å®¹</span></span><br><span class="line">        newlen += SDS_MAX_PREALLOC;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç®—å‡ºæ–°çš„ type ç±»å‹</span></span><br><span class="line">    type = sdsReqType(newlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ SDS_TYPE_5ï¼Œå¼ºåˆ¶è½¬æ¢æˆ SDS_TYPE_8ï¼Œé¿å…é¢‘ç¹æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5) type = SDS_TYPE_8;</span><br><span class="line">    <span class="comment">// ç®—å‡ºå¯¹åº”çš„ç»“æ„ä½“å¤§å°</span></span><br><span class="line">    hdrlen = sdsHdrSize(type);</span><br><span class="line">    <span class="comment">// ç±»å‹ç›¸åŒ</span></span><br><span class="line">    <span class="keyword">if</span> (oldtype==type) &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥æ‰©å®¹ buf å¤§å°</span></span><br><span class="line">        newsh = s_realloc(sh, hdrlen+newlen+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// æ–°çš„ s çš„åœ°å€</span></span><br><span class="line">        s = (<span class="keyword">char</span>*)newsh+hdrlen;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç±»å‹ä¸åŒäº†ï¼Œé‚£ä¹ˆéœ€è¦é‡æ–°åˆ†é…å†…å­˜</span></span><br><span class="line">        newsh = s_malloc(hdrlen+newlen+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// å°† s çš„å†…å®¹ä»¥åŠæœ«å°¾çš„ç»“æŸç¬¦å¤åˆ¶åˆ°æ–°çš„ buf ä¸­</span></span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span>*)newsh+hdrlen, s, len+<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ sh å†…å­˜</span></span><br><span class="line">        s_free(sh);</span><br><span class="line">        <span class="comment">// è·å– s çš„åœ°å€</span></span><br><span class="line">        s = (<span class="keyword">char</span>*)newsh+hdrlen;</span><br><span class="line">        <span class="comment">// è®¾ç½® type ç±»å‹</span></span><br><span class="line">        s[<span class="number">-1</span>] = type;</span><br><span class="line">        <span class="comment">// è®¾ç½® len å±æ€§</span></span><br><span class="line">        sdssetlen(s, len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½® alloc å±æ€§</span></span><br><span class="line">    sdssetalloc(s, newlen);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ±‚å‡º s ä¸­çš„å‰©ä½™ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ alloc - len çš„æ•°å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">size_t</span> <span class="title">sdsavail</span><span class="params">(<span class="keyword">const</span> sds s)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥éƒ½æ˜¯è·å– flagsï¼Œç„¶åé€šè¿‡ flags è·å–å…¶å¯¹åº”çš„æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags = s[<span class="number">-1</span>];</span><br><span class="line">    <span class="keyword">switch</span>(flags&amp;SDS_TYPE_MASK) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5: &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">8</span>,s);</span><br><span class="line">            <span class="keyword">return</span> sh-&gt;alloc - sh-&gt;len;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_16: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">16</span>,s);</span><br><span class="line">            <span class="keyword">return</span> sh-&gt;alloc - sh-&gt;len;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_32: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">32</span>,s);</span><br><span class="line">            <span class="keyword">return</span> sh-&gt;alloc - sh-&gt;len;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_64: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">64</span>,s);</span><br><span class="line">            <span class="keyword">return</span> sh-&gt;alloc - sh-&gt;len;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰©å®¹æµç¨‹å¦‚å›¾ï¼š</p>
</li>
</ul>
<hr>
<img src="/articles/2021/02/08/redis/Redis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2SDS/04.png" class="" width="540">

<hr>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† SDS ç›¸å…³çš„åŸºç¡€æ¦‚å¿µä»¥åŠæ¯”è¾ƒæ ¸å¿ƒæ–¹æ³•ï¼ŒSDS ä¸ºä¸Šå±‚æä¾›äº†ä¸°å¯Œçš„ APIï¼Œæœ¬æ–‡å°±ä¸å†ä»‹ç»äº†ã€‚é€šè¿‡è¿™å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•çš„åˆ†æï¼Œå…¶å®å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå¤§å¤šæ•°éƒ½æ˜¯å›´ç»• s ä»¥åŠå¸¸ç”¨çš„å®å±•å¼€çš„ï¼Œåªè¦å¤§å®¶æŠŠå®çœ‹æ‡‚è®°ä½é…åˆæŒ‡é’ˆæ“ä½œï¼Œé‚£ä¹ˆ SDS çš„å…¶ä»– API ä¹ŸåŒæ ·ç®€å•ã€‚å½“ç„¶ï¼Œæœ¬æ–‡ä¸»è¦è®²è§£ Redis æºç ï¼Œæ‰€ä»¥é»˜è®¤å¤§å®¶æ˜¯ç†Ÿç»ƒ C çš„ï¼Œæ‰€ä»¥å¯¹ä¸€äº›ç›¸å…³è¿ç®—åŠæ¦‚å¿µä¸ä¼šåšè¿‡å¤šä»‹ç»ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹æˆ‘çš„å…³äº C ç³»åˆ—çš„æ–‡ç« </p>
<hr>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li>ã€Redis 5 è®¾è®¡ä¸æºç åˆ†æã€‘</li>
<li><a target="_blank" rel="noopener" href="https://github.com/redis/redis/tree/6.0">ã€Redis 6.0.xã€‘</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/articles/tags/redis/" rel="tag"># redis</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/articles/2021/02/03/java_spring/SpringMVC%E7%AF%87(%E5%9B%9B)%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/" rel="prev" title="SpringMVC ç¯‡ï¼ˆå››ï¼‰å¼‚æ­¥è¯·æ±‚">
      <i class="fa fa-chevron-left"></i> SpringMVC ç¯‡ï¼ˆå››ï¼‰å¼‚æ­¥è¯·æ±‚
    </a></div>
      <div class="post-nav-item">
    <a href="/articles/2021/02/08/c_mini/C%E8%BF%B7%E4%BD%A0%E7%B3%BB%E5%88%97(%E4%BA%8C)%E6%9F%94%E6%80%A7%E6%95%B0%E7%BB%84/" rel="next" title="C è¿·ä½ ç³»åˆ—ï¼ˆäºŒï¼‰æŸ”æ€§æ•°ç»„">
      C è¿·ä½ ç³»åˆ—ï¼ˆäºŒï¼‰æŸ”æ€§æ•°ç»„ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å¼•è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">2.</span> <span class="nav-text">ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8"><span class="nav-number">2.1.</span> <span class="nav-text">äºŒè¿›åˆ¶å®‰å…¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">æ•°æ®ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E8%BF%9B"><span class="nav-number">2.2.0.1.</span> <span class="nav-text">æ”¹è¿›</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">3.</span> <span class="nav-text">åŸºæœ¬æ“ä½œ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8F"><span class="nav-number">3.1.</span> <span class="nav-text">å®</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">3.2.</span> <span class="nav-text">åˆ›å»ºå­—ç¬¦ä¸²</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8A%E6%94%BE%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">3.3.</span> <span class="nav-text">é‡Šæ”¾å­—ç¬¦ä¸²</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%BC%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">3.4.</span> <span class="nav-text">æ‹¼æ¥å­—ç¬¦ä¸²</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tubetrue01"
      src="/articles/img/head.PNG">
  <p class="site-author-name" itemprop="name">Tubetrue01</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/articles/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/articles/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Tubetrue01" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Tubetrue01" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tubetrue01</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/articles/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="/articles/lib/velocity/velocity.min.js"></script>
  <script src="/articles/lib/velocity/velocity.ui.min.js"></script>

<script src="/articles/js/utils.js"></script>

<script src="/articles/js/motion.js"></script>


<script src="/articles/js/schemes/pisces.js"></script>


<script src="/articles/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'b78837f065395b7c4761',
      clientSecret: '58c95c03db39e7430738d663bfc8337a5c8e1e80',
      repo        : 'articles',
      owner       : 'Tubetrue01',
      admin       : ['Tubetrue01'],
      id          : '1a78b545f965a60b2f1eace66ee90a1f',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
