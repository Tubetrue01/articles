<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/articles/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/articles/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/articles/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/articles/images/logo.svg" color="#222">

<link rel="stylesheet" href="/articles/css/main.css">


<link rel="stylesheet" href="/articles/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tubetrue01.github.io","root":"/articles/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å¼•è¨€ æœ¬æ–‡ä»¥å¾ªç¯ä¾èµ–ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»‹ç»ä¸€ä¸‹ Spring æ˜¯å¦‚ä½•å®ç° bean åˆ›å»ºä»¥åŠå¦‚ä½•é€šè¿‡ä¸‰çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯¹äº bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¯»å®Œæœ¬æ–‡ä¹‹åä¹Ÿéƒ½è¿åˆƒè€Œè§£ã€‚å¯¹äº†ï¼Œæœ¬æ–‡ç”¨åˆ°çš„ spring-boot-starter-parent ç‰ˆæœ¬ä¸ºï¼š2.5.15ã€‚  DefaultSingletonBeanRegistry DefaultSingletonBeanRegistry æ˜¯ Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring ç³»åˆ—ä¹‹ä»å¾ªç¯ä¾èµ–åˆ°ä¸‰çº§ç¼“å­˜">
<meta property="og:url" content="https://tubetrue01.github.io/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/">
<meta property="og:site_name" content="Tubetrue01">
<meta property="og:description" content="å¼•è¨€ æœ¬æ–‡ä»¥å¾ªç¯ä¾èµ–ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»‹ç»ä¸€ä¸‹ Spring æ˜¯å¦‚ä½•å®ç° bean åˆ›å»ºä»¥åŠå¦‚ä½•é€šè¿‡ä¸‰çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯¹äº bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¯»å®Œæœ¬æ–‡ä¹‹åä¹Ÿéƒ½è¿åˆƒè€Œè§£ã€‚å¯¹äº†ï¼Œæœ¬æ–‡ç”¨åˆ°çš„ spring-boot-starter-parent ç‰ˆæœ¬ä¸ºï¼š2.5.15ã€‚  DefaultSingletonBeanRegistry DefaultSingletonBeanRegistry æ˜¯ Spring">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tubetrue01.github.io/articles/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/01.jpg">
<meta property="og:image" content="https://tubetrue01.github.io/articles/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/02.png">
<meta property="article:published_time" content="2024-01-25T10:29:46.000Z">
<meta property="article:modified_time" content="2024-01-26T06:37:25.981Z">
<meta property="article:author" content="Tubetrue01">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tubetrue01.github.io/articles/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/01.jpg">

<link rel="canonical" href="https://tubetrue01.github.io/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Spring ç³»åˆ—ä¹‹ä»å¾ªç¯ä¾èµ–åˆ°ä¸‰çº§ç¼“å­˜ | Tubetrue01</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/articles/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tubetrue01</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/articles/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/articles/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/articles/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tubetrue01.github.io/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/articles/img/head.PNG">
      <meta itemprop="name" content="Tubetrue01">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tubetrue01">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring ç³»åˆ—ä¹‹ä»å¾ªç¯ä¾èµ–åˆ°ä¸‰çº§ç¼“å­˜
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-01-25 18:29:46" itemprop="dateCreated datePublished" datetime="2024-01-25T18:29:46+08:00">2024-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-01-26 14:37:25" itemprop="dateModified" datetime="2024-01-26T14:37:25+08:00">2024-01-26</time>
              </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><blockquote>
<p>æœ¬æ–‡ä»¥å¾ªç¯ä¾èµ–ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»‹ç»ä¸€ä¸‹ Spring æ˜¯å¦‚ä½•å®ç° bean åˆ›å»ºä»¥åŠå¦‚ä½•é€šè¿‡ä¸‰çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯¹äº bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¯»å®Œæœ¬æ–‡ä¹‹åä¹Ÿéƒ½è¿åˆƒè€Œè§£ã€‚å¯¹äº†ï¼Œæœ¬æ–‡ç”¨åˆ°çš„ spring-boot-starter-parent ç‰ˆæœ¬ä¸ºï¼š2.5.15ã€‚</p>
</blockquote>
<h1 id="DefaultSingletonBeanRegistry"><a href="#DefaultSingletonBeanRegistry" class="headerlink" title="DefaultSingletonBeanRegistry"></a>DefaultSingletonBeanRegistry</h1><blockquote>
<p>DefaultSingletonBeanRegistry æ˜¯ Spring é»˜è®¤çš„å•ä¾‹ bean æ³¨å†Œå™¨ï¼Œä¹Ÿæ˜¯ç›¸å½“é‡è¦çš„ä¸€ä¸ªæ³¨å†Œå™¨ï¼Œä¹Ÿæ˜¯ä¸‰çº§ç¼“å­˜çš„æŒæœ‰è€…ã€‚</p>
</blockquote>
<h2 id="ä¸‰çº§ç¼“å­˜"><a href="#ä¸‰çº§ç¼“å­˜" class="headerlink" title="ä¸‰çº§ç¼“å­˜"></a>ä¸‰çº§ç¼“å­˜</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€çº§ç¼“å­˜ï¼Œä¿å­˜ç€å®Œæ•´å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// äºŒçº§ç¼“å­˜ï¼Œä¿å­˜ç€å®ä¾‹åŒ–è¿˜æœªè¿›è¡Œåˆå§‹åŒ–çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‰çº§ç¼“å­˜ï¼Œä¿å­˜ç€åˆ›å»º bean çš„å·¥å‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="bean-å®ä¾‹ä¸ä¸‰çº§ç¼“å­˜"><a href="#bean-å®ä¾‹ä¸ä¸‰çº§ç¼“å­˜" class="headerlink" title="bean å®ä¾‹ä¸ä¸‰çº§ç¼“å­˜"></a>bean å®ä¾‹ä¸ä¸‰çº§ç¼“å­˜</h2><h3 id="getSingleton-String-beanName"><a href="#getSingleton-String-beanName" class="headerlink" title="getSingleton(String beanName)"></a>getSingleton(String beanName)</h3><blockquote>
<p>è¯¥æ–¹æ³•æ˜¯è·å– bean å®ä¾‹çš„å…¥å£æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨é‡è½½çš„ getSingleton æ–¹æ³•ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å…¥å‚ä¸º trueï¼Œä¹Ÿå°±æ˜¯å…è®¸è·å–æ—©æœŸçš„ bean å®ä¾‹ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getSingleton(beanName, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getSingleton-String-beanName-boolean-allowEarlyReference"><a href="#getSingleton-String-beanName-boolean-allowEarlyReference" class="headerlink" title="getSingleton(String beanName, boolean allowEarlyReference)"></a>getSingleton(String beanName, boolean allowEarlyReference)</h3><blockquote>
<p>è·å–å•ä¾‹ bean çš„å…·ä½“å®ç°ã€‚è¯¥æ–¹æ³•åˆ†åˆ«å°è¯•ä»ä¸€çº§ã€äºŒçº§ç¼“å­˜ä¸­è·å–å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨å°±éœ€è¦åˆ¤æ–­æ˜¯å¦å…è®¸æ—©æœŸçš„ bean å¼•ç”¨ï¼Œå¦‚æœå…è®¸åˆ™å°è¯•ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–ï¼Œç„¶åå°†ç”Ÿæˆçš„å®ä¾‹è½¬ç§»è‡³äºŒçº§ç¼“å­˜ï¼ŒåŒæ—¶ç§»é™¤å¯¹åº”çš„ä¸‰çº§ç¼“å­˜ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨æœªåŠ é”çš„æƒ…å†µä¸‹å°è¯•ä»ä¸€çº§ç¼“å­˜ä¸­è·å– bean å®ä¾‹</span></span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="comment">// åªæœ‰ä¸€çº§ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥ bean ä»¥åŠå½“å‰ bean å¤„äºåˆ›å»ºä¸­æ—¶æ‰è¿›è¡Œåç»­çš„å¤„ç†ï¼Œå¦åˆ™ç›´æ¥è¿”å›ï¼ˆä¸€çº§ç¼“å­˜å­˜åœ¨çš„è¯è¯´æ˜æ˜¯å®Œæ•´çš„ bean å¯ä»¥ç›´æ¥ç”¨ï¼›å¦‚æœä¸€çº§ç¼“å­˜ä¸å­˜åœ¨å¹¶ä¸”è¿˜æœªå¼€å§‹åˆ›å»ºè¯¥ bean é‚£ä¹ˆèµ°åˆ›å»ºæµç¨‹å°±è¡Œäº†ï¼Œæ¯•ç«Ÿæ­¤æ—¶äºŒçº§ã€ä¸‰çº§ç¼“å­˜éƒ½ä¸ºç©ºï¼Œèµ°é€»è¾‘ä¹Ÿæ²¡æ„ä¹‰ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="comment">// å…ˆçœ‹çœ‹äºŒçº§ç¼“å­˜æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">        <span class="comment">// å¦‚æœäºŒçº§ç¼“å­˜ä¸å­˜åœ¨ï¼Œå¹¶ä¸”å…è®¸æ—©æœŸè®¿é—®ï¼Œé‚£ä¹ˆå°±è¦åŠ é”è¿›è¡Œä¸‰çº§ç¼“å­˜çš„è·å–äº†</span></span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">                 singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                  <span class="comment">// åŠ é”ä¹‹åå†ä»ä¸€çº§ç¼“å­˜è·å–ï¼Œå¦‚æœè¿˜æœª nullï¼Œé‚£ä¹ˆå†ä»äºŒçº§ç¼“å­˜è·å–ï¼Œæ¯•ç«Ÿåœ¨åŠ é”è¿™æ®µæœŸé—´ï¼Œå¯èƒ½å½“å‰ bean å·²ç»è¢«å…¶çº¿ç¨‹åˆ›å»ºå¥½äº†ï¼ˆåªè¦æœ‰æ–¹æ³•è°ƒç”¨ getBean éƒ½ä¼šåˆ›å»ºå¯¹åº”çš„ bean å®ä¾‹ï¼‰</span></span><br><span class="line">                  <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// æ—¢ç„¶äºŒçº§ç¼“å­˜ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±å°è¯•è·å–ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">                            ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                            <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// æ³¨æ„ï¼Œä¸‰çº§ç¼“å­˜æ˜¯æä¾›çš„å¯¹è±¡å·¥å‚å®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ºä»£ç†æä¾›äº†é’©å­</span></span><br><span class="line">                                singletonObject = singletonFactory.getObject();</span><br><span class="line">                                <span class="comment">// é€šè¿‡ä¸‰çº§ç¼“å­˜è·å– bean å¯¹è±¡ï¼Œå°†å…¶ç§»å…¥åˆ°äºŒçº§ç¼“å­˜ï¼ŒåŒæ—¶åˆ é™¤ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">                                <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                                <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="addSingletonFactory"><a href="#addSingletonFactory" class="headerlink" title="addSingletonFactory"></a>addSingletonFactory</h2><blockquote>
<p>å½“å®ä¾‹å®ä¾‹åŒ–ä¹‹åï¼Œéœ€è¦å„ç§ä»£ç†å¯¹å…¶è¿›è¡ŒåŒ…è£…ï¼Œç„¶åæ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¶å®ä»åå­—ä¸Šæ¥çœ‹ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“è¯¥æ–¹æ³•æ˜¯å°† bean æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">	Assert.notNull(singletonFactory, <span class="string">&quot;Singleton factory must not be null&quot;</span>);</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">	        <span class="comment">// å¦‚æœä¸€çº§ç¼“å­˜ä¸­å·²ç»å­˜åœ¨äº†ï¼Œé‚£ä¹ˆè·³è¿‡</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">		        <span class="comment">// æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">			<span class="keyword">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">			<span class="comment">// å°†å½“å‰ bean ä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤</span></span><br><span class="line">			<span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">			<span class="comment">// ç™»è®°ä¸ºå·²æ³¨å†Œ</span></span><br><span class="line">			<span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ğŸ’¡ Tips</strong></p>
<blockquote>
<p>ä¸€çº§ç¼“å­˜å­˜åœ¨çš„è¯ï¼Œç›´æ¥è·³è¿‡ä¸‰çº§ç¼“å­˜çš„æ·»åŠ ï¼›å¦åˆ™å°†å…¶æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼ŒåŒæ—¶ä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤ã€‚</p>
</blockquote>
<h1 id="æµ‹è¯•ç”¨ä¾‹"><a href="#æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="æµ‹è¯•ç”¨ä¾‹"></a>æµ‹è¯•ç”¨ä¾‹</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> B b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> A a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä»¥ä¸¤ä¸ªæœ€åŸºæœ¬çš„ç±» Aã€B ä¸ºä¾‹å¼€å§‹æˆ‘ä»¬çš„ bean åˆ›å»ºä¹‹è·¯ï¼</p>
<h1 id="Bean-åˆ›å»º"><a href="#Bean-åˆ›å»º" class="headerlink" title="Bean åˆ›å»º"></a>Bean åˆ›å»º</h1><blockquote>
<p>å½“ç±»æ·»åŠ  @Lazy å£°æ˜ä¸ºæ‡’åŠ è½½æ—¶ï¼Œåªæœ‰å½“è¯¥ç±»çš„å¯¹è±¡è¢«ä½¿ç”¨æ—¶æ‰ä¼šå‡ºå‘ bean åˆ›å»ºï¼Œå…¶ä½™çš„ bean åœ¨ä¸Šä¸‹æ–‡åˆ·æ–°çš„æ—¶å€™å°±ä¼šæ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©åˆ›å»ºäº†ã€‚ç”¨ä¾‹ä¸­ï¼Œå³ä½¿ç±» Aã€B æ²¡æœ‰ä»»ä½•å­—æ®µéœ€è¦æ³¨å…¥ï¼Œä¹Ÿä¼šåˆ›å»ºå¯¹åº”çš„ beanã€‚</p>
</blockquote>
<img src="/articles/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/01.jpg" class="" width="1100">

<p>ä»è°ƒç”¨æ ˆå¯ä»¥çœ‹åˆ° <code>refresh()</code> æ–¹æ³•é€šè¿‡ <code>finishBeanFactoryInitialization()</code> ç”± bean å·¥å‚ <code>DefaultListableBeanFactory</code> çš„ <code>preInstantiateSingletons()</code> æ–¹æ³•å®Œæˆéæ‡’åŠ è½½ bean çš„å®ä¾‹åˆ›å»ºï¼Œä¹Ÿå°±æ˜¯è§¦å‘ <code>getBean()</code> æ–¹æ³•ã€‚</p>
<h2 id="getBean"><a href="#getBean" class="headerlink" title="getBean"></a>getBean</h2><blockquote>
<p>getBean å°†å…·ä½“é€»è¾‘å§”æ‰˜ç»™ doGetBean æ–¹æ³•æ¥å®ç°ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="doGetBean"><a href="#doGetBean" class="headerlink" title="doGetBean"></a>doGetBean</h2><blockquote>
<p>doGetBean æ–¹æ³•ä»£ç æ¯”è¾ƒå¤šï¼Œè€Œä¸”åˆ†æ”¯ä¸ä»…å¤šè¿˜å¾ˆæ·±ã€‚ä¸è¿‡ä¸è¦ç´§ï¼Œæˆ‘ä»¬é€æ­¥æŒ‘é‡ç‚¹æ¥ä¸€ç‚¹ä¸€ç‚¹å•ƒã€‚ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œå‡å¦‚æˆ‘ä»¬çš„ä¾‹å­ä¸­å…ˆè¡Œåˆ›å»ºçš„å®ä¾‹ä¸º Aã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(String name,<span class="meta">@Nullable</span> Class&lt;T&gt; requiredType,<span class="meta">@Nullable</span> Object[] args,<span class="keyword">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœéœ€è¦é‚£ä¹ˆå°±è½¬æ¢ bean çš„åå­—ï¼Œä¹Ÿå°±è¯´å¦‚æœ bean åå­—ç”± &amp; å¼€å¤´ï¼Œé‚£ä¹ˆå»æ‰å…¶å‰ç¼€ï¼ˆé’ˆå¯¹é‚£äº›å·¥å‚ beanï¼‰ï¼Œæœ¬æ¡ˆä¾‹ä¸­ name ä¸º &quot;a&quot;ã€&quot;b&quot;</span></span><br><span class="line">	String beanName = transformedBeanName(name);</span><br><span class="line">	Object beanInstance;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ç”±äºæ˜¯ç¬¬ä¸€æ¬¡è·å–ï¼Œé‚£ä¹ˆ sharedInstance è‚¯å®šä¸º nullï¼ˆæœ¬ä¾‹ä¸­ A çš„è·å–ä¼šå­˜åœ¨å¤šæ¬¡ï¼Œæˆ‘ä»¬ç¨åä»‹ç»ï¼‰</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Object sharedInstance = getSingleton(beanName);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ç¬¬ä¸€æ¬¡ç”±äº sharedInstance ä¸º nullï¼Œæ‰€ä»¥è¯¥åˆ†æ”¯ä¸ä¼šèµ°ï¼Œæˆ‘ä»¬åœ¨åç»­ä»‹ç»ä¸ä¸º null çš„åœºæ™¯</span></span><br><span class="line">	<span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +</span><br><span class="line">						<span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// å¼€å§‹å…·ä½“çš„ bean åˆ›å»ºé€»è¾‘ï¼Œå¦‚æœå½“å‰ bean æ˜¯åŸå‹æ¨¡å¼ï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹å·²ç»åœ¨åˆ›å»ºä¸­ï¼Œé‚£ä¹ˆä¸€æ¬æ˜¯ä¸ä¼šå†æ¬¡åˆ›å»ºäº†ï¼Œé™¤éé‡åˆ°å¾ªç¯ä¾èµ–ï¼Œé‚£ä¹ˆå°±æŠ›å‡ºå¼‚å¸¸ï¼ˆä¹Ÿå°±æ˜¯è¯´åŸå‹æ¨¡å¼ä¸‹ï¼ŒSpring å¹¶ä¸è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼‰</span></span><br><span class="line">		<span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// è·å–çˆ¶çº§å·¥å‚</span></span><br><span class="line">		BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">		<span class="comment">// å¦‚æœå­˜åœ¨çˆ¶çº§å·¥å‚åŒæ—¶æŸ¥çœ‹æ˜¯å¦åŒ…å«å½“å‰çš„ bean å®šä¹‰</span></span><br><span class="line">		<span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">		 </span><br><span class="line">			<span class="comment">// è·å–è¯¥ bean çš„åŸå§‹åå­—ï¼Œç„¶åæ ¹æ®éœ€è¦æ·»åŠ  &amp; å‰ç¼€</span></span><br><span class="line">			String nameToLookup = originalBeanName(name);</span><br><span class="line">			<span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">				<span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">						nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// Delegation to parent with explicit args.</span></span><br><span class="line">				<span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (requiredType != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">				<span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœæœ¬æ¬¡å¹¶éæ˜¯ä½œä¸ºç±»å‹æ£€æµ‹è§¦å‘çš„ getBean è°ƒç”¨ï¼Œé‚£ä¹ˆå°†è¯¥ bean æ ‡è®°ä¸ºå·²åˆ›å»ºï¼ˆbean å·¥å‚çº§ç¼“å­˜ï¼‰</span></span><br><span class="line">		<span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">			markBeanAsCreated(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		StartupStep beanCreation = <span class="keyword">this</span>.applicationStartup.start(<span class="string">&quot;spring.beans.instantiate&quot;</span>)</span><br><span class="line">				.tag(<span class="string">&quot;beanName&quot;</span>, name);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (requiredType != <span class="keyword">null</span>) &#123;</span><br><span class="line">				beanCreation.tag(<span class="string">&quot;beanType&quot;</span>, requiredType::toString);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// æŸ¥æ‰¾æŒ‡å®šåå­—çš„ bean å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯ Spring å¯¹è¯¥ bean å¯¹è±¡çš„è¯¦ç»†æè¿°</span></span><br><span class="line">			RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">		        <span class="comment">// æŸ¥çœ‹ bean æ˜¯å¦æ˜¯æŠ½è±¡çš„ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸ </span></span><br><span class="line">			checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">	                <span class="comment">// è·å–å½“å‰ bean ä¾èµ–çš„ beanï¼Œæ¯”å¦‚é€šè¿‡ @DependsOn æ³¨è§£æ˜¾ç¤ºå£°æ˜ä¾èµ–ï¼Œé‚£ä¹ˆå°±éœ€è¦å…ˆåˆ›å»ºè¿™äº› beanï¼ˆæœ¬ä¾‹ä¸­ Aã€B å‡æ— ä»»ä½•ä¾èµ–ï¼‰</span></span><br><span class="line">			String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">			<span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">				        <span class="comment">// å¯ä»¥ä¾èµ–ï¼Œä½†æ˜¯ä½ ä¸èƒ½å¾ªç¯ä¾èµ–äº†</span></span><br><span class="line">					<span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">								<span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">// ç™»è®°ä¾èµ–ä¿¡æ¯</span></span><br><span class="line">					registerDependentBean(dep, beanName);</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">					        <span class="comment">// è§¦å‘ä¾èµ– bean çš„åˆ›å»º</span></span><br><span class="line">						getBean(dep);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">								<span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å•ä¾‹ beanï¼ˆæœ¬ä¾‹è‚¯å®šæ˜¯èµ°è¿™ä¸ªåˆ†æ”¯äº†ï¼‰</span></span><br><span class="line">			<span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">			        <span class="comment">// è°ƒç”¨ getSingleton æ–¹æ³•ï¼Œå¹¶æ³¨å†Œå›è°ƒæ–¹æ³•ä¸º createBean</span></span><br><span class="line">				sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">						<span class="comment">// Explicitly remove instance from singleton cache: It might have been put there</span></span><br><span class="line">						<span class="comment">// eagerly by the creation process, to allow for circular reference resolution.</span></span><br><span class="line">						<span class="comment">// Also remove any beans that received a temporary reference to the bean.</span></span><br><span class="line">						destroySingleton(beanName);</span><br><span class="line">						<span class="keyword">throw</span> ex;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">				<span class="comment">// å¦‚æœæ˜¯å·¥å‚ bean é‚£ä¹ˆå°±éœ€è¦è·å–å…·ä½“çš„å®ä¾‹</span></span><br><span class="line">				beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">			&#125;</span><br><span class="line">                        <span class="comment">// åŸå‹ bean</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">				<span class="comment">// It&#x27;s a prototype -&gt; create a new instance.</span></span><br><span class="line">				Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					beforePrototypeCreation(beanName);</span><br><span class="line">					prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">finally</span> &#123;</span><br><span class="line">					afterPrototypeCreation(beanName);</span><br><span class="line">				&#125;</span><br><span class="line">				beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">			        <span class="comment">// å…¶ä»–ä½œç”¨åŸŸçš„ bean åˆ›å»º</span></span><br><span class="line">				String scopeName = mbd.getScope();</span><br><span class="line">				<span class="keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No scope name defined for bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line">				<span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Object scopedInstance = scope.get(beanName, () -&gt; &#123;</span><br><span class="line">						beforePrototypeCreation(beanName);</span><br><span class="line">						<span class="keyword">try</span> &#123;</span><br><span class="line">							<span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">finally</span> &#123;</span><br><span class="line">							afterPrototypeCreation(beanName);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;);</span><br><span class="line">					beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> ScopeNotActiveException(beanName, scopeName, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">			beanCreation.tag(<span class="string">&quot;exception&quot;</span>, ex.getClass().toString());</span><br><span class="line">			beanCreation.tag(<span class="string">&quot;message&quot;</span>, String.valueOf(ex.getMessage()));</span><br><span class="line">			cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			beanCreation.end();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// åˆ¤æ–­å®é™…çš„ bean ä¸ç±»å‹æ˜¯å¦åŒ¹é…ï¼Œç„¶ååšç›¸åº”è½¬æ¢</span></span><br><span class="line">	<span class="keyword">return</span> adaptBeanInstance(name, beanInstance, requiredType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>doGetBean</code> æ–¹æ³•å°†å…·ä½“çš„å•ä¾‹ bean åˆ›å»ºå§”æ‰˜ç»™äº† <code>AbstractAutowireCapableBeanFactory</code> å·¥å‚çš„ <code>createBean</code> æ–¹æ³•ã€‚è€Œè¯¥æ–¹æ³•åˆä½•æ—¶è§¦å‘çš„å‘¢ï¼Ÿæˆ‘ä»¬è¿›å…¥ <code>getSingleton</code> ä¸€æ¢ç©¶ç«Ÿï¼</p>
<h2 id="getSingleton"><a href="#getSingleton" class="headerlink" title="getSingleton"></a>getSingleton</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼¼æ›¾ç›¸è¯†çš„ getSingletonï¼Œåªä¸è¿‡å‚æ•°å˜äº†</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">	Assert.notNull(beanName, <span class="string">&quot;Bean name must not be null&quot;</span>);</span><br><span class="line">	<span class="comment">// å…ˆé”ä½ä¸€çº§ç¼“å­˜</span></span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">		Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                <span class="comment">// å¦‚æœä¸€çº§ç¼“å­˜ä¸å­˜åœ¨ï¼Œé‚£å°±ä¸å¾—ä¸åˆ›å»ºäº†</span></span><br><span class="line">		<span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">		        <span class="comment">// å¦‚æœå•ä¾‹å·¥å‚å·²ç»å¯ç”¨è‡ªæ¯æ¨¡å¼äº†ï¼Œå°±ä¸è¦å†åˆ›å»º bean äº†</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.singletonsCurrentlyInDestruction) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationNotAllowedException(beanName,</span><br><span class="line">						<span class="string">&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot;</span> +</span><br><span class="line">						<span class="string">&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Creating shared instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// å½“å‰ bean ä¸èƒ½å¤„äºæ’é™¤åå•ä¸­ï¼Œå°†å½“å‰ bean æ ‡è®°ä¸ºåˆ›å»ºä¸­çŠ¶æ€</span></span><br><span class="line">			beforeSingletonCreation(beanName);</span><br><span class="line">			<span class="keyword">boolean</span> newSingleton = <span class="keyword">false</span>;</span><br><span class="line">			<span class="comment">// æ˜¯å¦éœ€è¦è®°å½•æŠ‘åˆ¶çš„å¼‚å¸¸</span></span><br><span class="line">			<span class="keyword">boolean</span> recordSuppressedExceptions = (<span class="keyword">this</span>.suppressedExceptions == <span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">// é›†åˆä¸ºç©ºå°±åˆ›å»ºæ–°çš„é›†åˆ</span></span><br><span class="line">			<span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">				<span class="keyword">this</span>.suppressedExceptions = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			        <span class="comment">// è¿™é‡Œä¼šå›è°ƒ `AbstractAutowireCapableBeanFactory` å·¥å‚çš„ `createBean` æ–¹æ³•å®Œæˆå¯¹è±¡åˆ›å»º</span></span><br><span class="line">				singletonObject = singletonFactory.getObject();</span><br><span class="line">				newSingleton = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">				<span class="comment">// æ€è€ƒä¸‹æ­¤æ—¶å‡ºç°çš„åœºæ™¯ï¼Ÿ</span></span><br><span class="line">				singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">				<span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> ex;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">				<span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">				        <span class="comment">// å°†æŠ‘åˆ¶çš„å¼‚å¸¸è¿½ç¼´åˆ°å¼‚å¸¸é“¾ï¼Œä¸€å¹¶æŠ›å‡º</span></span><br><span class="line">					<span class="keyword">for</span> (Exception suppressedException : <span class="keyword">this</span>.suppressedExceptions) &#123;</span><br><span class="line">						ex.addRelatedCause(suppressedException);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">			        <span class="comment">// é‡ç½®å¼‚å¸¸é›†åˆ</span></span><br><span class="line">				<span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">					<span class="keyword">this</span>.suppressedExceptions = <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// å°† bean ä»åˆ›å»ºä¸­çŠ¶æ€ä¸­ç§»é™¤</span></span><br><span class="line">				afterSingletonCreation(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// å¦‚æœæ–°çš„å®ä¾‹åˆ›å»ºå®Œæ¯•ï¼Œé‚£ä¹ˆæ·»åŠ åˆ°ä¸€çº§ç¼“å­˜</span></span><br><span class="line">			<span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">				addSingleton(beanName, singletonObject);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> singletonObject;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„ bean åˆ›å»ºåˆå§”æ‰˜ç»™äº† <code>AbstractAutowireCapableBeanFactory</code> å·¥å‚çš„ <code>createBean</code> æ–¹æ³•ï¼Œå½“å¯¹è±¡åˆ›å»ºåä¼šé€šè¿‡ <code>addSingleton</code> æ–¹æ³•æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œä¸è¿‡æˆ‘ä»¬å…ˆçœ‹åˆ›å»ºæµç¨‹ï¼</p>
<h2 id="createBean"><a href="#createBean" class="headerlink" title="createBean"></a>createBean</h2><blockquote>
<p>createBean æ˜¯ <code>AbstractAutowireCapableBeanFactory</code> çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”¨äº bean çš„åˆ›å»ºï¼Œä¸è¿‡ä»åå­—ä½ ä¹Ÿå¯ä»¥çœ‹çš„å‡ºæ¥ï¼Œå®ƒè‚¯å®šè¿˜æœ‰ä¸ª doCreateBean æ–¹æ³•ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span> <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">		logger.trace(<span class="string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	RootBeanDefinition mbdToUse = mbd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è§£æé™¤è¯¥ bean æ‰€å±çš„ç±»ï¼ˆæœ¬ä¾‹ä¸­å°±æ˜¯ A.classã€B.class çš„å…¨é™å®šåï¼‰</span></span><br><span class="line">	Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">	<span class="keyword">if</span> (resolvedClass != <span class="keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		mbdToUse = <span class="keyword">new</span> RootBeanDefinition(mbd);</span><br><span class="line">		mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">// ç”¨æ¥å¤„ç†å½“å‰ bean ä¸­çš„æ–¹æ³•é‡å†™</span></span><br><span class="line">            mbdToUse.prepareMethodOverrides();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(mbdToUse.getResourceDescription(),</span><br><span class="line">				beanName, <span class="string">&quot;Validation of method overrides failed&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// BeanPostProcessors å¯ä»¥ä»è¿™ä¸ªé˜¶æ®µç›´æ¥ç”Ÿæˆä»£ç†å¯¹è±¡ä»¥å–ä»£å®é™…çš„ beanï¼ˆå½“ç„¶ï¼Œäº‹åŠ¡ç›¸å…³çš„ä»£ç†è‚¯å®šä¸ä»è¿™ä¸ªé˜¶æ®µç”Ÿæˆï¼‰</span></span><br><span class="line">		Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">		<span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> bean;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">				<span class="string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="comment">// ç»§ç»­å§”æ‰˜ç»™ doCreateBean æ–¹æ³•</span></span><br><span class="line">		Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> beanInstance;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">		<span class="comment">// A previously detected exception with proper bean creation context already,</span></span><br><span class="line">		<span class="comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span></span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">				mbdToUse.getResourceDescription(), beanName, <span class="string">&quot;Unexpected exception during bean creation&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="doCreateBean"><a href="#doCreateBean" class="headerlink" title="doCreateBean"></a>doCreateBean</h2><blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œèµ°åˆ°è¿™é‡Œè¿˜æ²¡å¼€å§‹åˆ›å»º bean å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸€å±‚ä¼šæœ‰å®ç°å—ï¼Ÿæˆ‘çŒœä¹Ÿä¸ä¼šï¼</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// bean çš„åŒ…è£…å™¨ï¼ŒæŒæœ‰çœŸæ­£çš„ bean å¯¹è±¡</span></span><br><span class="line">	BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">	        <span class="comment">// ä»ç¼“å­˜ä¸­åˆ é™¤ï¼Œå¦‚æœä¸å­˜åœ¨å°±å¾—åˆ›å»ºäº†</span></span><br><span class="line">		instanceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">// æ­¤æ—¶çœŸæ­£çš„ bean å¯¹è±¡å°±åˆ›å»ºå®Œæˆå¹¶ä¿å­˜åœ¨ instanceWrapper ä¸­</span></span><br><span class="line">		instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å…·ä½“çš„ bean å®ä¾‹å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯æœ¬ä¾‹ä¸­çš„ A æˆ–è€… Bï¼‰</span></span><br><span class="line">	Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">	Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">	<span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">		mbd.resolvedTargetType = beanType;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">	<span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			        <span class="comment">// è¿™é‡Œå…è®¸ä½ å¯¹ bean å®šä¹‰è¿›è¡Œå¤„ç†</span></span><br><span class="line">				applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">						<span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			mbd.postProcessed = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">	<span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">	<span class="comment">// ä»¥ä¸‹å°±æ˜¯è§£å†³å¾ªç¯ä¾èµ–çš„å…³é”®ç¼“å­˜äº†ï¼Œä»æ³¨è§£ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå“ªæ€•æ˜¯ç±»ä¼¼ BeanFactoryAware ç”Ÿå‘½å‘¨æœŸæ¥å£è§¦å‘çš„éƒ½ä¸åœ¨è¯ä¸‹</span></span><br><span class="line">	<span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">			isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">	<span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">					<span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// å°†å½“å‰å¯¹è±¡ç”± getEarlyBeanReference åŒ…è£…å¹¶å­˜å…¥ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">		addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the bean instance.</span></span><br><span class="line">	Object exposedObject = bean;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="comment">// å¯ç”¨å±æ€§å¡«å……ï¼Œè¿™é‡Œå°±è¦å®Œæˆä¾èµ–æ³¨å…¥äº†ï¼Œæˆ‘ä»¬ç¨åè¯¦ç»†ä»‹ç»</span></span><br><span class="line">		populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">		<span class="comment">// å¼€å§‹åˆå§‹åŒ– bean å®Œæˆå„ç§ç”Ÿå‘½å‘¨æœŸé’©å­è°ƒç”¨ï¼Œå…·ä½“çš„æˆ‘ä»¬ç¨åä»‹ç»</span></span><br><span class="line">		exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">			<span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">					mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">	        <span class="comment">// è¿™é‡Œæš‚æ—¶ä¸ä»‹ç»ï¼ˆæ¯•ç«Ÿ A çš„æµç¨‹æš‚æ—¶ä¸ä¼šèµ°å®Œï¼Œå…ˆèµ°å®Œè¿™ä¸€æ­¥çš„æ˜¯ B å¯¹è±¡ï¼Œè€Œä¸”ä¸¤è€…çš„æƒ…å†µè¿˜ä¸å¤ªä¸€æ ·ï¼‰</span></span><br><span class="line">		Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">				exposedObject = earlySingletonReference;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">				String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">				Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">				<span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">						actualDependentBeans.add(dependentBean);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</span><br><span class="line">							<span class="string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; has been injected into other beans [&quot;</span> +</span><br><span class="line">							StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">							<span class="string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +</span><br><span class="line">							<span class="string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +</span><br><span class="line">							<span class="string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +</span><br><span class="line">							<span class="string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="comment">// æ³¨å†Œ DestructionAwareBeanPostProcessorsã€DisposableBean interfaceã€custom destroy method ç­‰æ–¹æ³•</span></span><br><span class="line">		registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">				mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å±æ€§å¡«å……"><a href="#å±æ€§å¡«å……" class="headerlink" title="å±æ€§å¡«å……"></a>å±æ€§å¡«å……</h1><blockquote>
<p>è‡ªåŠ¨æ³¨å…¥å°±å‘ç”Ÿåœ¨å½“å‰é˜¶æ®µã€‚</p>
</blockquote>
<h2 id="populateBean"><a href="#populateBean" class="headerlink" title="populateBean"></a>populateBean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">populateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> BeanWrapper bw)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ bean å®ä¾‹æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">	<span class="keyword">if</span> (bw == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mbd.hasPropertyValues()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">					mbd.getResourceDescription(), beanName, <span class="string">&quot;Cannot apply property values to null instance&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Skip property population phase for null instance.</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span></span><br><span class="line">	<span class="comment">// state of the bean before properties are set. This can be used, for example,</span></span><br><span class="line">	<span class="comment">// to support styles of field injection.</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// InstantiationAwareBeanPostProcessors æ¥å£å®ç°å›è°ƒï¼Œæ­¤æ—¶ bean ä»…ä»…æ˜¯å®ä¾‹åŒ–è¿˜æœªè¿›è¡Œå±æ€§å¡«å……</span></span><br><span class="line">	<span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">		<span class="keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">		        <span class="comment">// å¯ä»¥æŒ‡å®šæ˜¯å¦è¿›è¡Œæ¥ä¸‹æ¥çš„å±æ€§å¡«å……</span></span><br><span class="line">			<span class="keyword">if</span> (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ bean çš„æ³¨å…¥æ–¹å¼ï¼Œç”±äºæ˜¯ bean çš„åˆ›å»ºï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯ 0 ï¼ˆä¸éœ€è¦æ³¨å…¥ï¼‰</span></span><br><span class="line">	<span class="keyword">int</span> resolvedAutowireMode = mbd.getResolvedAutowireMode();</span><br><span class="line">	<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">		MutablePropertyValues newPvs = <span class="keyword">new</span> MutablePropertyValues(pvs);</span><br><span class="line">		<span class="comment">// Add property values based on autowire by name if applicable.</span></span><br><span class="line">		<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">			autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Add property values based on autowire by type if applicable.</span></span><br><span class="line">		<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">			autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">		&#125;</span><br><span class="line">		pvs = newPvs;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨åç½®å¤„ç†å™¨</span></span><br><span class="line">	<span class="keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">	<span class="keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">	PropertyDescriptor[] filteredPds = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (hasInstAwareBpps) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pvs == <span class="keyword">null</span>) &#123;</span><br><span class="line">			pvs = mbd.getPropertyValues();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">		        <span class="comment">// è¿™é‡Œç€é‡æ³¨æ„ AutowiredAnnotationBeanPostProcessor å¤„ç†å™¨ï¼Œç”±å®ƒè´Ÿè´£è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">			PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);</span><br><span class="line">			<span class="keyword">if</span> (pvsToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (filteredPds == <span class="keyword">null</span>) &#123;</span><br><span class="line">					filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">				&#125;</span><br><span class="line">				pvsToUse = bp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">				<span class="keyword">if</span> (pvsToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			pvs = pvsToUse;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (needsDepCheck) &#123;</span><br><span class="line">		<span class="keyword">if</span> (filteredPds == <span class="keyword">null</span>) &#123;</span><br><span class="line">			filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">		&#125;</span><br><span class="line">		checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pvs != <span class="keyword">null</span>) &#123;</span><br><span class="line">		applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è‡ªåŠ¨æ³¨å…¥å®ç°"><a href="#è‡ªåŠ¨æ³¨å…¥å®ç°" class="headerlink" title="è‡ªåŠ¨æ³¨å…¥å®ç°"></a>è‡ªåŠ¨æ³¨å…¥å®ç°</h3><blockquote>
<p>AutowiredAnnotationBeanPostProcessor è´Ÿè´£å®Œæˆè‡ªåŠ¨æ³¨å…¥ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PropertyValues <span class="title">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æŸ¥åˆ°å½“å‰ bean çš„æ³¨å…¥å…ƒæ•°æ®å¯¹è±¡</span></span><br><span class="line">	InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="comment">// è°ƒç”¨æ³¨å…¥æ–¹æ³•</span></span><br><span class="line">		metadata.inject(bean, beanName, pvs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> pvs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object target, <span class="meta">@Nullable</span> String beanName, <span class="meta">@Nullable</span> PropertyValues pvs)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">	Collection&lt;InjectedElement&gt; checkedElements = <span class="keyword">this</span>.checkedElements;</span><br><span class="line">	Collection&lt;InjectedElement&gt; elementsToIterate =</span><br><span class="line">			(checkedElements != <span class="keyword">null</span> ? checkedElements : <span class="keyword">this</span>.injectedElements);</span><br><span class="line">	 <span class="comment">// éå†éœ€è¦æ³¨å…¥çš„å…ƒç´ ï¼Œå›åˆ°æˆ‘ä»¬çš„ä¾‹å­ï¼Œå› ä¸º A æœ‰ä¸€ä¸ªæ³¨å…¥å±æ€§ Bï¼Œæ‰€ä»¥è¿™é‡Œæ³¨å…¥çš„å…ƒç´ å°±æ˜¯ Bï¼›å¯¹äº B è¿™é‡Œæ³¨å…¥çš„å…ƒç´ å°±æ˜¯ A</span></span><br><span class="line">	<span class="keyword">if</span> (!elementsToIterate.isEmpty()) &#123;</span><br><span class="line">		<span class="keyword">for</span> (InjectedElement element : elementsToIterate) &#123;</span><br><span class="line">		        <span class="comment">// ç”±äº B å±äºå­—æ®µæ³¨å…¥ï¼Œè¿™é‡Œ element çš„å®ç°ä¸ºå†…éƒ¨ç±»ï¼šAutowiredFieldElement</span></span><br><span class="line">			element.inject(target, beanName, pvs);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object bean, <span class="meta">@Nullable</span> String beanName, <span class="meta">@Nullable</span> PropertyValues pvs)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–éœ€è¦æ³¨å…¥çš„å­—æ®µï¼Œæœ¬ä¾‹ä¸­ bean A å¯¹åº” Bï¼›bean B å¯¹åº” Aã€‚</span></span><br><span class="line">  Field field = (Field) <span class="keyword">this</span>.member;</span><br><span class="line">  Object value;</span><br><span class="line">  <span class="comment">// ç¬¬ä¸€æ¬¡è‚¯å®šæ˜¯æ²¡æœ‰ç¼“å­˜çš„</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.cached) &#123;</span><br><span class="line">  	<span class="keyword">try</span> &#123;</span><br><span class="line">  		value = resolvedCachedArgument(beanName, <span class="keyword">this</span>.cachedFieldValue);</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">  		<span class="comment">// Unexpected removal of target bean for cached argument -&gt; re-resolve</span></span><br><span class="line">  		value = resolveFieldValue(field, bean, beanName);</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸»æµç¨‹å¼€å§‹å¯¹å­—æ®µ B è¿›è¡Œè§£æï¼Œè¿™ä¸ªé˜¶æ®µä¼šè§¦å‘ B çš„æ„é€ ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ getBean() å®Œæˆ B åˆ›å»ºï¼Œè€Œ B åŒæ ·æœ‰å­—æ®µï¼Œæ‰€ä»¥åˆä¼šå›åˆ°æœ¬æ–¹æ³•ï¼Œåªä¸è¿‡è¿™é‡Œå°±è¦è§£æ B çš„å­—æ®µ A äº†ï¼Œé‚£ä¹ˆåˆä¼šè§¦å‘ getBean å»æ„é€  Aï¼Œä½†æ˜¯æ­¤æ—¶ A å·²ç»å¤„äºä¸‰çº§ç¼“å­˜ä¸­äº†ï¼Œé‚£ä¹ˆå°±ä¼šå°† A ä»ä¸‰çº§ç¼“å­˜ä¸­è§£æå‡ºæ¥ï¼Œå­˜å…¥äºŒçº§ç¼“å­˜ï¼Œå®Œæˆ B å¯¹è±¡ä¸­ A çš„æ³¨å…¥ã€‚ç„¶åå®Œæˆ B å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œæ­¤æ—¶å°±ä¼šå›åˆ° A çš„è°ƒç”¨ä¸­æ¥ï¼Œvalue å°±æ˜¯å·²ç»åˆå§‹åŒ–å®Œæˆä½äºä¸€çº§ç¼“å­˜ä¸­çš„ Bï¼Œç„¶åè®¾ç½®ç»™ Aã€‚ç”±äº A è¿˜æœªåˆå§‹åŒ–å®Œæˆï¼Œæ‰€ä»¥ B ä¸­çš„ A ç”±äºæŒ‡å‘äº†ç›¸åŒçš„å¼•ç”¨ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æœªåˆå§‹åŒ–çš„ã€‚é‚£ä¹ˆå½“å­—æ®µè®¾ç½®å®Œæ¯•ï¼Œå°±ä¼šç»§ç»­ A çš„åˆå§‹åŒ–äº†ï¼Œé‚£ä¹ˆå½“ A å®Œæˆï¼ŒB ä¸­çš„ A ä¹Ÿè‡ªç„¶æ˜¯å®Œæ•´çš„å¯¹è±¡ã€‚</span></span><br><span class="line">  	value = resolveFieldValue(field, bean, beanName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®è®¿é—®æƒé™ï¼Œç„¶åå®Œæˆè®¾ç½®</span></span><br><span class="line">  	ReflectionUtils.makeAccessible(field);</span><br><span class="line">  	field.set(bean, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¯¹äº <code>resolveFieldValue</code> æ–¹æ³•ï¼Œè¿™é‡Œå°±ä¸å†è¿›è¡Œå±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ï¼Œè¯¥æ–¹æ³•ä¼šé—´æ¥è°ƒç”¨ <code>getBean()</code> æ¥å®Œæˆ B å®ä¾‹çš„æ„é€ ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸ºäº†é¿å…å¤§å®¶æ€ç»ªæ··ä¹±ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å½“å‰å‘ç”Ÿäº†å“ªäº›è¿‡ç¨‹ï¼š<br>1ã€getBean æ–¹æ³•ç¬¬ä¸€è°ƒç”¨ï¼Œæ„é€ å¯¹è±¡ Aï¼Œå°†å…¶åŒ…è£…ä¹‹åå­˜å…¥ä¸‰çº§ç¼“å­˜ï¼›<br>2ã€A è¿›è¡Œå±æ€§å¡«å……ï¼Œå‘ç° A å­˜åœ¨å­—æ®µ Bï¼Œè€Œ B ä¹Ÿæ˜¯ bean å¯¹è±¡ï¼Œè§¦å‘ B çš„ getBean è°ƒç”¨ï¼›<br>3ã€è°ƒç”¨ getBean åˆ›å»º Bï¼Œç„¶åå°† B è¿›è¡ŒåŒ…è£…å­˜å…¥ä¸‰çº§ç¼“å­˜ï¼›<br>4ã€å¡«å…… B çš„å±æ€§ï¼Œå‘ç° B å«æœ‰å­—æ®µ Aï¼›<br>5ã€é‚£ä¹ˆè§¦å‘ A çš„ getBeanï¼Œå®Œæˆ A æ„é€ ï¼›</p>
<p>ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œæˆ‘ä»¬å†æ¬¡å›åˆ° doGetBean æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­¤æ—¶ç”±äº A å¤„äºä¸‰çº§ç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆ sharedInstance å°±ä¸ä¼šä¸º null</span></span><br><span class="line">Object sharedInstance = getSingleton(beanName);</span><br><span class="line"><span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +</span><br><span class="line">					<span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å› ä¸º A å¹¶éæ˜¯ factoryBeanï¼Œæ‰€ä»¥ beanInstance å°±ä¼šç›´æ¥è¿”å›å®Œæˆ doGetBean æ–¹æ³•çš„è°ƒç”¨</span></span><br><span class="line">	beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº getSingleton æ–¹æ³•å·²ç»å­˜åœ¨ A çš„å®ä¾‹ï¼Œé‚£ä¹ˆå°±ä¼šé€šè¿‡ A å¯¹åº”çš„å·¥å‚æ–¹æ³•æ‹¿åˆ°å…·ä½“çš„ A å¯¹è±¡ï¼Œç„¶åå°†è¯¥å®ä¾‹å­˜å…¥äºŒçº§ç¼“å­˜ï¼ŒåŒæ—¶ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">    singletonObject = singletonFactory.getObject();</span><br><span class="line">    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ A å¯¹åº”çš„å·¥å‚å¯¹è±¡æ˜¯è°å‘¢ï¼Ÿè¿˜è®°å¾—ä»¥ä¸‹ä»£ç ä¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†å½“å‰å¯¹è±¡ç”± getEarlyBeanReference åŒ…è£…å¹¶å­˜å…¥ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç åœ¨ deCreateBean å®ä¾‹åŒ– A ä¹‹åï¼Œä¼šå°†å…¶æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼Œè€Œ <code>getEarlyBeanReference</code> å°±æ˜¯ A å¯¹åº”çš„ä½äº <code>AbstractAutowireCapableBeanFactory</code> ä¸­çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(String beanName, RootBeanDefinition mbd, Object bean)</span> </span>&#123;</span><br><span class="line">	Object exposedObject = bean;</span><br><span class="line">	<span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">		<span class="keyword">for</span> (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123;</span><br><span class="line">			exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>getBeanPostProcessorCache().smartInstantiationAware</code> çš„å®ç°æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li><h4 id="InfrastructureAdvisorAutoProxyCreator"><a href="#InfrastructureAdvisorAutoProxyCreator" class="headerlink" title="InfrastructureAdvisorAutoProxyCreator"></a>InfrastructureAdvisorAutoProxyCreator</h4><p>æ–¹æ³•ç”±çˆ¶ç±» <code>AbstractAutoProxyCreator</code> å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(Object bean, String beanName)</span> </span>&#123;</span><br><span class="line">	Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">	<span class="comment">// é¿å…é‡å¤åˆ›å»ºä»£ç†ï¼Œå°†è¯¥å¯¹è±¡å­˜å…¥ç¼“å­˜è¿›è¡Œæ ‡è®°</span></span><br><span class="line">	<span class="keyword">this</span>.earlyProxyReferences.put(cacheKey, bean);</span><br><span class="line">	<span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç”±äºä»£ç†æ˜¯åœ¨åç»­çš„ process ä¸­åˆ›å»ºçš„ï¼Œæ‰€ä»¥æœ¬æ¡ä»¶ä¸æˆç«‹</span></span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="keyword">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å› ä¸º A å¹¶ä¸éœ€è¦ä»£ç†ï¼Œæ‰€ä»¥è¿™é‡Œä¸º null</span></span><br><span class="line">	<span class="keyword">if</span> (Boolean.FALSE.equals(<span class="keyword">this</span>.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ç”±äº A å¹¶é Adviceã€Pointcutã€Advisorã€AopInfrastructureBeanï¼Œæ‰€ä»¥æœ¬æ¡ä»¶ä¹Ÿä¸æˆç«‹</span></span><br><span class="line">	<span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">		<span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å› ä¸º A ä¸éœ€è¦ä»£ç†ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸º null</span></span><br><span class="line">	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="keyword">null</span>);</span><br><span class="line">	<span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">		<span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">		Object proxy = createProxy(</span><br><span class="line">				bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> SingletonTargetSource(bean));</span><br><span class="line">		<span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">		<span class="keyword">return</span> proxy;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// å¯¹ A è¿›è¡Œç™»è®°ï¼Œç„¶åè¿”å›</span></span><br><span class="line">	<span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">	<span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¯¥æ–¹æ³•å¹¶æ²¡æœ‰å¯¹ A å¯¹è±¡æœ‰ä»»ä½•æ”¹é€ ã€‚</p>
</li>
<li><h4 id="AutowiredAnnotationBeanPostProcessor"><a href="#AutowiredAnnotationBeanPostProcessor" class="headerlink" title="AutowiredAnnotationBeanPostProcessor"></a>AutowiredAnnotationBeanPostProcessor</h4><p>æ–¹æ³•ç”±çˆ¶ç±» <code>SmartInstantiationAwareBeanPostProcessor</code> å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">default</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¹Ÿåªæ˜¯ç®€å•çš„è¿”å›ã€‚</p>
</li>
</ul>
<p>6ã€é€šè¿‡ä»¥ä¸Šæˆ‘ä»¬å¯ä»¥çŸ¥é“æ­¤æ—¶çš„ A ç”±äºä¸éœ€è¦ä»£ç†ï¼Œæ‰€ä»¥æ‹¿åˆ°çš„å°±æ˜¯å½“åˆåˆ›å»ºçš„ A å¯¹è±¡ï¼Œç„¶åå°† A ä»ä¸‰çº§ç¼“å­˜ç§»å…¥åˆ°äºŒçº§ç¼“å­˜ï¼Œå¹¶æ³¨å…¥åˆ° B ä¸­ã€‚å…¶å®é€šè¿‡å¾ªç¯ä¾èµ–ï¼Œæˆ‘å¯èƒ½ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœéœ€è¦ä»£ç†åŒ…è£…æ—¶ï¼Œä»£ç†ä¹Ÿå¹¶éç¬¬ä¸€æ¬¡å°±åˆ›å»ºå‡ºæ¥ï¼Œè€Œæ˜¯åœ¨éœ€è¦ç”¨åˆ°è¯¥å¯¹è±¡å®ä¾‹æ—¶ï¼Œæ‰ä¼šä»ä¸‰çº§ç¼“å†²ä¸­å¾—åˆ°ä»£ç†å¯¹è±¡ã€‚<br>7ã€å½“ B å®ä¾‹æ³¨å…¥å®Œ A å­—æ®µä¹‹åï¼Œé‚£ä¹ˆå°±ä¼šç»“æŸ B çš„å±æ€§å¡«å……é˜¶æ®µï¼Œæ¥ä¸‹æ¥å°±æ˜¯åˆå§‹åŒ–é˜¶æ®µäº†ã€‚</p>
<h1 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h1><blockquote>
<p>æˆ‘ä»¬ç»§ç»­ä¸Šä¸€é˜¶æ®µä»‹ç»ï¼Œä¸Šä¸€é˜¶æ®µä¸­ï¼ŒA å¯¹è±¡åˆ°äº†å±æ€§å¡«å……é˜¶æ®µï¼Œè€Œå±æ€§å¡«å……å¯¼è‡´ B çš„åˆ›å»ºï¼ŒB çš„åˆ›å»ºåŒæ ·æ¥åˆ°å±æ€§å¡«å……é˜¶æ®µï¼Œè§¦å‘ A çš„åˆ›å»ºï¼Œå½“ B å®Œæˆ A å­—æ®µçš„æ³¨å…¥ä¹‹åä¹ŸåŒæ ·éœ€è¦è¿›è¡Œæ¥ä¸‹æ¥çš„åˆå§‹åŒ–ã€‚æ¢è€Œè¨€ä¹‹ï¼ŒA åœ¨ç­‰å¾… B çš„åˆå§‹åŒ–å®Œæˆç„¶åå†ç»§ç»­ A çš„åˆå§‹åŒ–ã€‚</p>
</blockquote>
<h2 id="initializeBean"><a href="#initializeBean" class="headerlink" title="initializeBean"></a>initializeBean</h2><blockquote>
<p>æœ¬é˜¶æ®µå°±ç®€å•å¤šäº†ï¼Œä¸»è¦æ˜¯ bean ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„å¤„ç†ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">initializeBean</span><span class="params">(String beanName, Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨å„ç§ aware æ–¹æ³•ï¼Œå¦‚ï¼šBeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAwareï¼Œå’¦ï¼Ÿæ€ä¹ˆæ²¡æœ‰ ApplicationContextAware å‘¢ï¼Ÿ</span></span><br><span class="line">	<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">			invokeAwareMethods(beanName, bean);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;, getAccessControlContext());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		invokeAwareMethods(beanName, bean);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Object wrappedBean = bean;</span><br><span class="line">	<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">	        <span class="comment">// è°ƒç”¨ BeanPostProcessor çš„ postProcessBeforeInitialization æ–¹æ³•</span></span><br><span class="line">		wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="comment">// è°ƒç”¨ InitializingBean æ¥å£å®ç°ï¼Œä»¥åŠè‡ªå®šä¹‰çš„ init æ–¹æ³•</span></span><br><span class="line">		invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">				(mbd != <span class="keyword">null</span> ? mbd.getResourceDescription() : <span class="keyword">null</span>),</span><br><span class="line">				beanName, <span class="string">&quot;Invocation of init method failed&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">	        <span class="comment">// è°ƒç”¨ BeanPostProcessor çš„ postProcessAfterInitialization æ–¹æ³•</span></span><br><span class="line">		wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ğŸ’¡ Tips</strong></p>
<blockquote>
<p>æ³¨æ„ä¸è¦æŠŠ BeanPostProcessor çš„ Initialization æ–¹æ³•ä¸å…¶å­ç±» InstantiationAwareBeanPostProcessor çš„ Instantiation æ–¹æ³•ææ··å“ˆï¼Œå‰è€…æ˜¯åˆå§‹åŒ–å‰åé’©å­ï¼Œåè€…æ˜¯å®ä¾‹åŒ–å‰åé’©å­ã€‚</p>
</blockquote>
<p>è¿˜è®°å¾— <code>doCreateBean</code> åœ¨åˆå§‹åŒ–å®Œæˆä¹‹åæœ‰ä¸ªæ¡ä»¶åˆ¤æ–­ä¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶ beanName ä¸º Bï¼Œè€Œå¯ç”¨æ—©æœŸå¼•ç”¨ä¸º falseï¼Œä¹Ÿå°±æ˜¯è¯´åªä»ä¸€çº§äºŒçº§ç¼“å­˜ä¸­è·å–å®ä¾‹ã€‚è¿˜è®°å¾—æ­¤æ—¶ç¼“å­˜çš„çŠ¶æ€ä¸ï¼ŸA å­˜åœ¨äºäºŒçº§ç¼“å­˜ï¼›è€Œ A è·å– B æ—¶ï¼ŒB å¤„äºç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæ‰€ä»¥å®ƒè¿˜åœ¨ä¸‰çº§ç¼“å­˜ä¸­ã€‚æ‰€ä»¥æ­¤æ—¶è·å– B ä¸º nullï¼› è·å– A æ—¶å¾—åˆ°çš„å°±æ˜¯äºŒçº§ç¼“å­˜ä¸­çš„å®ä¾‹ã€‚æ—¢ç„¶è¿™æ ·ï¼ŒB åœ¨æ³¨å†Œå®Œä½™ä¸‹çš„é’©å­ä¹‹åå°±ç»“æŸäº†ã€‚å¦å¤–å¦‚æœç¼“å­˜ä¸­å­˜åœ¨è¿™ä¸ªå¯¹è±¡ï¼Œè¯´æ˜å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œé‚£ä¹ˆå°±éœ€è¦æ…é‡å¤„ç†äº†</span></span><br><span class="line">	Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">	<span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * å¦‚æœä¸¤è€…ç›¸ç­‰ï¼Œè¯´æ˜åœ¨ initializeBean é˜¶æ®µå¹¶æ²¡æœ‰ä»£ç†äº§ç”Ÿï¼Œå¯ä»¥æ”¾å¿ƒçš„è¿”å›ã€‚ä½†æ˜¯å¦‚æœä¸æƒ³ç­‰ï¼Œè¯´æ˜ exposedObject è¢«æ›¿æ¢æˆäº†ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">		<span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">			exposedObject = earlySingletonReference;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// æ—¢ç„¶å¯¹è±¡è¢«ä»£ç†äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦æ£€æŸ¥æ˜¯ç”±æœ‰å…¶ä»–å·²ç»åˆ›å»ºå®Œæˆçš„ bean ä¾èµ–äº†å½“å‰å¯¹è±¡ï¼ˆæ¯”å¦‚è¯´ï¼šåœ¨å±æ€§å¡«å……é˜¶æ®µå·²ç»ä¸º B å¡«å……äº†å¯¹è±¡ Aï¼Œä½†æ˜¯åœ¨åˆå§‹åŒ–é˜¶æ®µï¼ŒA è¢«æ›¿æ¢æˆäº†ä»£ç†å¯¹è±¡äº†ã€‚é‚£ä¹ˆæ˜¾ç„¶ B ä¸­çš„ A ä¸å®é™…ä¸­çš„ A å¹¶ä¸ç›¸ç­‰ï¼Œé‚£ä¸å°±å‡ºé—®é¢˜äº†ï¼‰</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">			String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">			Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">			<span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">			        <span class="comment">// å¦‚æœè¯¥å¯¹è±¡ç”¨äºå®é™…çš„ä½¿ç”¨ä¸ºç›®çš„ï¼Œå¹¶éäº†ç±»å‹æ£€æŸ¥ï¼Œé‚£ä¹ˆæ–¹æ³•å°±ä¼šè¿”å› false</span></span><br><span class="line">				<span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">					actualDependentBeans.add(dependentBean);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// å¦‚æœé›†åˆä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±è¦æŠ¥é”™äº†ï¼ˆä½ æ˜æ˜éƒ½å·²ç»æ³¨å…¥å®Œæ¯•äº†ï¼Œä¸ºå•¥çªç„¶åˆæ”¹å˜äº†ï¼‰</span></span><br><span class="line">			<span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</span><br><span class="line">						<span class="string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; has been injected into other beans [&quot;</span> +</span><br><span class="line">						StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">						<span class="string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +</span><br><span class="line">						<span class="string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +</span><br><span class="line">						<span class="string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +</span><br><span class="line">						<span class="string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»™å®šçš„ bean æ˜¯å¦ä»…ä»…ä¸ºäº†ç±»å‹æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeSingletonIfCreatedForTypeCheckOnly</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸€ä¸ª bean å¹¶éä¸ºäº†ç±»å‹æ£€æŸ¥è€Œåˆ›å»ºæ—¶ï¼Œä¼šè¢«æ ‡è®°ä¸ºå·²åˆ›å»ºçŠ¶æ€ï¼ˆè¢«æ·»åŠ åˆ° alreadyCreated é›†åˆä¸­ï¼‰ï¼Œå¦‚æœé›†åˆä¸å­˜åœ¨ï¼Œè¯´æ˜è¯¥ bean é™¤äº†ç±»å‹æ£€æŸ¥æ²¡æœ‰å…¶ä»–ç›®çš„ï¼Œé‚£ä¹ˆå°±è¿”å› trueï¼›å¦‚æœå½“å‰é›†åˆå­˜åœ¨ï¼Œè¯´æ˜è¯¥ bean æ˜¯ä½œä¸ºå®é™…ä½¿ç”¨çš„ï¼Œé‚£ä¹ˆè¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.alreadyCreated.contains(beanName)) &#123;</span><br><span class="line">        removeSingleton(beanName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h1><blockquote>
<p>ä»€ä¹ˆæ—¶å€™è½¬ç§»è‡³ä¸€çº§ç¼“å­˜å‘¢ï¼Ÿæ¯•ç«Ÿ B å½“å‰å¤„äºä¸‰çº§ç¼“å­˜ï¼ŒA å¤„äºäºŒçº§ç¼“å­˜ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»ä¸€çº§ç¼“å­˜çš„è½¬æ¢ã€‚</p>
</blockquote>
<h2 id="addSingleton"><a href="#addSingleton" class="headerlink" title="addSingleton"></a>addSingleton</h2><blockquote>
<p>è¿˜è®°å¾—æ˜¯è°è´Ÿè´£åˆ›å»ºçš„ bean ä¸ï¼ŸdoCreateBean æ–¹æ³•ï¼Œé‚£ä¹ˆè°è§¦å‘çš„ doCreateBean å‘¢ï¼Ÿæ˜¯ createBean æ–¹æ³•ï¼Œé‚£ä¹ˆåˆæ˜¯è°è§¦å‘çš„ createBean å‘¢ï¼Ÿæ˜¯ getSingleton æ–¹æ³•é€šè¿‡å›è°ƒæ¥è§¦å‘çš„ã€‚psï¼šæ˜¯è°è§¦å‘çš„ getSingleton æ–¹æ³•å˜ï¼Ÿé‚£è¿˜ç”¨è¯´å˜›ï¼Œå½“ç„¶æ˜¯ doGetBean äº†ï¼Œé‚£ä¹ˆè§¦å‘ doGetBean çš„æ–¹æ³•å‘¢ã€‚ã€‚ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæ–°çš„å®ä¾‹åˆ›å»ºå®Œæ¯•ï¼Œé‚£ä¹ˆæ·»åŠ åˆ°ä¸€çº§ç¼“å­˜</span></span><br><span class="line"><span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">	addSingleton(beanName, singletonObject);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>getSingleton</code> æ–¹æ³•æœ€åï¼Œæˆ‘é€šè¿‡æ³¨é‡Šå·²ç»è¯´æ˜äº†ï¼Œä¸çŸ¥é“å¤§å®¶è¿˜è®°å¾—ä¸ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹ <code>addSingleton()</code> æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingleton</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">	        <span class="comment">// å°†å¯¹è±¡æ”¾åˆ°ä¸€çº§ç¼“å­˜</span></span><br><span class="line">		<span class="keyword">this</span>.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">		<span class="comment">// ä»ä¸‰çº§ç¼“å­˜ç§»é™¤</span></span><br><span class="line">		<span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">		<span class="comment">// ä»äºŒçº§ç¼“å­˜ç§»é™¤</span></span><br><span class="line">		<span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">		<span class="comment">// å°† bean çš„åå­—ç¼“å­˜èµ·æ¥</span></span><br><span class="line">		<span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä»¥ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒA ç»å†äº†ä¸‰çº§ç¼“å­˜åˆ°äºŒçº§ï¼ŒäºŒçº§åˆ°ä¸€çº§ï¼ŒB åˆ™æ˜¯ç›´æ¥ä»ä¸‰çº§è·³è¿‡äº†äºŒçº§ç›´æ¥è¿›å…¥äº†ä¸€çº§ç¼“å­˜ã€‚</p>
<hr>
<h1 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>é€šè¿‡æœ¬æ–‡å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿˜æœ‰æ³¨å…¥æ–¹å¼ä¸ºå­—æ®µæ³¨å…¥ã€setter æ³¨å…¥è§£å†³äº†å¾ªç¯ä¾èµ–ã€‚å¯¹äºä»£ç†è€Œè¨€ï¼Œå¹¶éç¬¬ä¸€æ¬¡åˆ›å»ºå®ä¾‹æ—¶å°±åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯æ”¾åˆ°äº†ä½¿ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œæ‰ä¼šä»ä¸‰çº§ç¼“å­˜ä¸­ç”Ÿæˆä»£ç†å¯¹è±¡å®Œæˆæ³¨å…¥ã€‚ä»å¦ä¸€ä¸ªè§’åº¦æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä¸‰çº§ç¼“å­˜çš„å­˜åœ¨å…¶å®å°±æ˜¯ä¸ºäº†åº”å¯¹åŠ¨æ€ä»£ç†ï¼Œå¦åˆ™ä¸¤çº§ç¼“å­˜å°±å¤Ÿäº†ã€‚</p>
<hr>
<h2 id="é€ä¸Šä¸€å¼ å…¨å®¶ç¦"><a href="#é€ä¸Šä¸€å¼ å…¨å®¶ç¦" class="headerlink" title="é€ä¸Šä¸€å¼ å…¨å®¶ç¦"></a>é€ä¸Šä¸€å¼ å…¨å®¶ç¦</h2><img src="/articles/2024/01/25/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%88%B0%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/02.png" class="" width="1100">

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/articles/tags/Java/" rel="tag"># Java</a>
              <a href="/articles/tags/Spring/" rel="tag"># Spring</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/articles/2023/09/13/entertainment/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E6%94%B9%E9%80%A0/" rel="prev" title="å®¶åº­ç½‘ç»œç¯å¢ƒæ”¹é€ ">
      <i class="fa fa-chevron-left"></i> å®¶åº­ç½‘ç»œç¯å¢ƒæ”¹é€ 
    </a></div>
      <div class="post-nav-item">
    <a href="/articles/2024/01/26/java_spring/Spring%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BB%8EAOP%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/" rel="next" title="Spring ç³»åˆ—ä¹‹ä» AOP è§’åº¦åˆ†æå¾ªç¯ä¾èµ–">
      Spring ç³»åˆ—ä¹‹ä» AOP è§’åº¦åˆ†æå¾ªç¯ä¾èµ– <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å¼•è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DefaultSingletonBeanRegistry"><span class="nav-number">2.</span> <span class="nav-text">DefaultSingletonBeanRegistry</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">2.1.</span> <span class="nav-text">ä¸‰çº§ç¼“å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bean-%E5%AE%9E%E4%BE%8B%E4%B8%8E%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">2.2.</span> <span class="nav-text">bean å®ä¾‹ä¸ä¸‰çº§ç¼“å­˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getSingleton-String-beanName"><span class="nav-number">2.2.1.</span> <span class="nav-text">getSingleton(String beanName)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getSingleton-String-beanName-boolean-allowEarlyReference"><span class="nav-number">2.2.2.</span> <span class="nav-text">getSingleton(String beanName, boolean allowEarlyReference)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#addSingletonFactory"><span class="nav-number">2.3.</span> <span class="nav-text">addSingletonFactory</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">æµ‹è¯•ç”¨ä¾‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Bean-%E5%88%9B%E5%BB%BA"><span class="nav-number">4.</span> <span class="nav-text">Bean åˆ›å»º</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#getBean"><span class="nav-number">4.1.</span> <span class="nav-text">getBean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#doGetBean"><span class="nav-number">4.2.</span> <span class="nav-text">doGetBean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getSingleton"><span class="nav-number">4.3.</span> <span class="nav-text">getSingleton</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createBean"><span class="nav-number">4.4.</span> <span class="nav-text">createBean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#doCreateBean"><span class="nav-number">4.5.</span> <span class="nav-text">doCreateBean</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E5%A1%AB%E5%85%85"><span class="nav-number">5.</span> <span class="nav-text">å±æ€§å¡«å……</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#populateBean"><span class="nav-number">5.1.</span> <span class="nav-text">populateBean</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.1.1.</span> <span class="nav-text">è‡ªåŠ¨æ³¨å…¥å®ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">5.2.</span> <span class="nav-text">æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#InfrastructureAdvisorAutoProxyCreator"><span class="nav-number">5.2.0.1.</span> <span class="nav-text">InfrastructureAdvisorAutoProxyCreator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AutowiredAnnotationBeanPostProcessor"><span class="nav-number">5.2.0.2.</span> <span class="nav-text">AutowiredAnnotationBeanPostProcessor</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">6.</span> <span class="nav-text">åˆå§‹åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#initializeBean"><span class="nav-number">6.1.</span> <span class="nav-text">initializeBean</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">7.</span> <span class="nav-text">ä¸€çº§ç¼“å­˜</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#addSingleton"><span class="nav-number">7.1.</span> <span class="nav-text">addSingleton</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">8.</span> <span class="nav-text">æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%81%E4%B8%8A%E4%B8%80%E5%BC%A0%E5%85%A8%E5%AE%B6%E7%A6%8F"><span class="nav-number">8.1.</span> <span class="nav-text">é€ä¸Šä¸€å¼ å…¨å®¶ç¦</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tubetrue01"
      src="/articles/img/head.PNG">
  <p class="site-author-name" itemprop="name">Tubetrue01</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/articles/archives/">
        
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/articles/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Tubetrue01" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Tubetrue01" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/articles/Tubetrue01@gmail.com" title="E-Mail â†’ Tubetrue01@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tubetrue01</span>
</div>



        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/articles/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="/articles/lib/velocity/velocity.min.js"></script>
  <script src="/articles/lib/velocity/velocity.ui.min.js"></script>

<script src="/articles/js/utils.js"></script>

<script src="/articles/js/motion.js"></script>


<script src="/articles/js/schemes/pisces.js"></script>


<script src="/articles/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'b78837f065395b7c4761',
      clientSecret: '58c95c03db39e7430738d663bfc8337a5c8e1e80',
      repo        : 'articles',
      owner       : 'Tubetrue01',
      admin       : ['Tubetrue01'],
      id          : 'c773acea279c488e248beea13f549e8c',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
